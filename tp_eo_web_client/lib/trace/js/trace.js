/*! ElectricOfficeWeb 5.0.1 2021-06-16 */
define(["jquery","underscore","results-list","OpenLayers3","i18n!viewer/nls/messages","map-loader","text!trace-partials/trace.html","text!trace-partials/node.html","text!trace-partials/icon-block.svg","text!trace-partials/icon-start.svg","text!trace-partials/icon-finish.svg","hogan","comms","map-helper","map-core-component/pubsub"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"use strict";var o=l.compile(g),p=l.compile(h),q={block:l.compile(i),start:l.compile(j),finish:l.compile(k)},r="trace",s=n.getMapProjection(),t={strokeWidth:5,strokeColor:"rgba(255, 153, 0, 0.75)"};f.style&&(t=b.extend(t,f.style.tracing));var u,v,w,x,y,z,A,B,C,D=new d.style.Stroke({color:t.strokeColor,width:t.strokeWidth}),E=new d.style.Circle({radius:10,fill:new d.style.Fill({color:[0,0,0,1]}),stroke:D}),F=new d.style.Style({stroke:D,image:E}),G={},H={trace_array:[]},I="start",J={start:{"class":"start",icon:"icon-ico_play_rnd_lg"},finish:{"class":"finish",icon:"icon-ico_stop_rnd_lg"},block:{"class":"block",icon:"icon-ico_ban1_lg"}},K=["id","icon","name","class","placeHolder","invalidMarker"],L="input-group",M=L+" has-error",N=function(){a.subscribe("sidebarContainerReady",function(a,b){a===r&&Q(b,{id:a})}),a.subscribe("leavingSidebar",function(a){a===r&&P()}),a.subscribe("gotoSidebar",function(b){if(b===r){switch(I){case"start":G.$startNodeBtnSelector.addClass("active");break;case"finish":G.$finishNodeBtnSelector.addClass("active");break;case"block":G.$blockNodeBtnSelector.addClass("active")}a.publish("disablePopovers"),T(),C=a.subscribe("featureSelected",function(b){if("start"!==I||na()){var c=b.features.features[0];O(I,c.id,b.lonlat,c.name)}else a.publish("raiseTempMessage",[e.trace.placeStartNodeNotAllowed,{messageType:"info"}])})}}),a.subscribe("mapInitialised",function(a,b){v=b,w=a}),a.subscribe("setTraceStartingPoint",function(b){return void 0!==b.lonlat?(a.publish("openSidebarToItem",[r]),O("start",b.urn,b.lonlat,b.objectType),void a.publish("clearPopovers")):b.geometry?(a.publish("openSidebarToItem",[r]),O("start",b.urn,b.geometry.coordinates,b.objectType),void a.publish("clearPopovers")):void a.publish("raiseTempMessage",[e.trace.unableToSendToTrace,{messageType:"info"}])}),a.subscribe("popoverButtonVisibilityControl",function(b){"popoverButtonSendToTrace"===b[0].id&&(f.isAvailable(r)?a(b[0]).css("display","inline"):a(b[0]).css("display","none"))})};N();var O=function(b,c,d,e){a("#findMain .node-controls #"+b+"Node").click();var f=ha(c,d,e,H[ia()].icons[b]);fa(b,f)},P=function(){a.publish("enablePopovers"),a("#findMain .node-controls > .btn").removeClass("active"),C&&a.unsubscribe(C)},Q=function(a){u=a,Ba()},R=function(){z.spin(),a(a("#traceFinalize #submit")[0]).attr("disabled","disabled")},S=function(){z.spin(!1),a(a("#traceFinalize #submit")[0]).removeAttr("disabled")},T=function(){if(!A){var a=new d.source.Vector({}),b=new d.layer.Vector({source:a,extent:s.maxExtent,maxResolution:s.maxResolution,renderOrder:null,visible:!0,name:"Trace layer",style:F});v.addLayer(b),A=b}},U=function(){A&&A.getSource().clear()},V=function(){var b={messages:e,traces:H.trace_array};u.append(o.render(b)),oa(),ja(),W();var d=a("#find-results",u);x=c.getNewResultsList({selector:d,paging:!0,map:{olMap:v,mapName:w},parentComponent:r,"export":!0,filter:!0}),z=a(u[0]).find("#trace_spinner"),a("[rel=tooltip]").tooltip({container:"body"})},W=function(){a("#traceFinalize #cancel").on("click touchend",X),a("#traceFinalize #submit").on("click touchend",Z)},X=function(){b.each(H,function(a,b){"trace_array"!==b&&pa(b,!0)}),za(),ra(),Y()},Y=function(){U(),x&&x.clear(),Fa()},Z=function(){$()},$=function(){var c=a.extend(!0,{},H[ia()].nodes);b.each(c,function(a){a instanceof Array?b.each(a,function(a){_(a)}):_(a)}),0===c.start.coordinates.length&&(c={});var d={json:"true",trace_type:ia(),crs:s.name,result_type:"all",nodes:JSON.stringify(c),ace_visibility_tag:f.tags.results||"web_export"};la()&&(d.direction=G.$traceDirectionSelector.val()),ma()&&(d.max_length=G.$distanceInput.val().split(" ").join("")),R(),m.postGSSRequest(d,"?service=ejb%2FTraceLocal&method=runTrace",da,aa)},_=function(a){b.each(K,function(b){delete a[b]})},aa=function(b){a.publish("raiseStickyMessage",[e.trace.traceFailed,{messageType:"warning",errorMessage:b.responseText}]),Y(),S()},ba=function(a){b.each(a,function(a){ka("start")&&ca(H[ia()].nodes.start,a),ka("finish")&&ca(H[ia()].nodes.finish,a),ka("block")&&b.each(H[ia()].nodes.block,function(b){ca(b,a)})})},ca=function(a,b){if(a.urn===b){var c=new d.Feature({geometry:new d.geom.Point(a.coordinates)});c.setId(a.id),A.getSource().addFeature(c),a["class"]=M,a.invalidMarker=c,ra()}},da=function(c){Y(),c.response?(a.publish("raiseTempMessage",[c.response.message,{messageType:"warning"}]),ba(c.response.markers_list)):(a.publish("raiseTempMessage",[e.trace.traceComplete,{messageType:"success"}]),a.publish("setTraceResult",[c]),c.features&&c.features.features&&x.renderResults(c.features.features,{geographic_context:c.geographic_context,resultType:ia(),"export":{title:e.trace.exportFileTitle,fileName:e.trace.exportFileName}}),B=c,b.each(c.visited_geoms,function(a,c){if(n.isGeographicWorld(c))return void b.each(a,function(a){var b=n.parseData([{coordinates:a.coordinates,type:"LineString"}]);A.getSource().addFeatures(b)})}),c.breakpoints&&a.publish("breakpoints",[c.breakpoints]),0!==A.getSource().getFeatures().length&&n.gotoExtentsOfLayer(v,A)),S()},ea=function(a,b){I=b},fa=function(a,c){H[ia()].icons[a].visibility="visible","start"===a&&b.each(H,function(a,b){"trace_array"!==b&&(ga(a.nodes.start),a.nodes.start=c)}),"finish"===a&&(ga(H[ia()].nodes[a]),H[ia()].nodes[a]=c),"block"===a&&H[ia()].nodes[a].push(c),xa(),ra()},ga=function(a){if(void 0!==a.invalidMarker){var b=A.getSource().getFeatureById(a.id);b&&A.getSource().removeFeature(b)}},ha=function(a,b,c,d){var e=b[0]+b[1]+Math.random();return{id:a+"-"+e,urn:a,coordinates:b,name:c,icon:d,"class":L}},ia=function(){return G.$traceTypeSelector.val()},ja=function(){G.$traceTypeSelector=a("select#traceType",u),G.$startNodeBtnSelector=a("button#startNode",u),G.$finishNodeBtnSelector=a("button#finishNode",u),G.$blockNodeBtnSelector=a("button#blockNode",u),G.$traceDirectionSelector=a("select#trace-direction",u),G.$distanceLabel=a("label#distance-label",u),G.$distanceInput=a("input#distance",u),G.$startNodeBtnSelector.on("click touchend",function(b){ea(a(this),"start")}),G.$finishNodeBtnSelector.on("click touchend",function(b){ea(a(this),"finish")}),G.$blockNodeBtnSelector.on("click touchend",function(b){ea(a(this),"block")}),G.$buttonSelector=a(".node-controls button",u),G.$buttonSelector.on("click touchend",function(){G.$buttonSelector.removeClass("active"),a(this).addClass("active")}),G.$traceTypeSelector.change(function(a){pa(ia(),!1),H[this.value].nodes.start["class"]=L,ka("start")&&na()?G.$startNodeBtnSelector.css("display","inline"):G.$startNodeBtnSelector.css("display","none"),ka("finish")?G.$finishNodeBtnSelector.css("display","inline"):G.$finishNodeBtnSelector.css("display","none"),ka("block")?G.$blockNodeBtnSelector.css("display","inline"):G.$blockNodeBtnSelector.css("display","none"),la()?G.$traceDirectionSelector.css("display","inline"):G.$traceDirectionSelector.css("display","none"),ma()?(G.$distanceLabel.css("display","inline"),G.$distanceInput.css("display","inline")):(G.$distanceLabel.css("display","none"),G.$distanceInput.css("display","none")),za(),ra(),Y(),xa()}),G.$traceTypeSelector.change(),ra()},ka=function(a){var c=H[ia()].node_types;return!!b.contains(c,a)},la=function(){return H[ia()].include_direction},ma=function(){return H[ia()].include_distance},na=function(){return!b.has(H[ia()],"can_place_start_node_on_map")||H[ia()].can_place_start_node_on_map},oa=function(){b.each(H,function(a,b){"trace_array"!==b&&pa(b,!0)})},pa=function(a,c){b.contains(H[a].node_types,"start")&&c&&va(a,"start",e.trace.startNodeButton),b.contains(H[a].node_types,"block")&&(H[a].nodes.block=[]),b.contains(H[a].node_types,"finish")&&va(a,"finish",e.trace.finishNodeButton)},qa=function(a,b){return{id:"",coordinates:[],placeHolder:b,name:"",icon:a,"class":L}},ra=function(){G.$nodesListSelector=a("#trace-nodes-list",u),G.$traceTypeSelector=a("select#traceType",u);var c=H[G.$traceTypeSelector.val()];G.$nodesListSelector.empty(),ka("start")&&G.$nodesListSelector.append(p.render(c.nodes.start)),ka("block")&&b.each(c.nodes.block,function(a){G.$nodesListSelector.append(p.render(a))}),ka("finish")&&G.$nodesListSelector.append(p.render(c.nodes.finish)),a("#trace-nodes-list .icon-ico_cross_rnd_sm").on("click touchend",sa)},sa=function(b){var c=a(b.currentTarget).attr("id").split("remove_")[1];""!==c&&(ta(b,c),xa(),ra())},ta=function(c,d){if(void 0!==a(a("div[id='id_"+d+"']")[0])[0]){var f=A.getSource().getFeatureById(d);f&&A.getSource().removeFeature(f)}var g=ia();return ua("start",d)?void b.each(H,function(a,b){"trace_array"!==b&&va(b,"start",e.trace.startNodeButton)}):ua("finish",d)?void va(g,"finish",e.trace.finishNodeButton):void b.each(H[g].nodes.block,function(a){if(ka("block")&&a.id===d){var b=H[g].nodes.block.indexOf(a);return void(b!==-1&&H[g].nodes.block.splice(b,1))}})},ua=function(a,b){var c=ia();return!(!ka(a)||H[c].nodes[a].id!==b)},va=function(a,b,c){H[a].icons[b].visibility="hidden",H[a].nodes[b]=qa(H[a].icons[b],c)},wa=function(a){var b=40,c=40,d="",e=q[a].render({height:c,width:b});return d="data:image/svg+xml;charset=utf-8;base64,"+btoa(e)},xa=function(){var c=a("select#traceType",u),d=H[c.val()];y&&za(),ya(),ka("start")&&Aa(d.nodes.start,"start"),ka("block")&&b.each(d.nodes.block,function(a){Aa(a,"block")}),ka("finish")&&""!==d.nodes.finish.id&&Aa(d.nodes.finish,"finish")},ya=function(){var a=new d.source.Vector({});y=new d.layer.Vector({name:"Markers",source:a}),v.addLayer(y)},za=function(){a.publish("clearHighlight",[w]),a.publish("clearBreakpoints"),y&&(v.removeLayer(y),y=void 0)},Aa=function(a,b){if(""!==a.id&&void 0!==a.id){var c=new d.Feature({geometry:new d.geom.Point(a.coordinates)}),e=wa(b),f=new d.style.Style({image:new d.style.Icon({size:[40,70],imgSize:[40,70],src:e})});return c.setStyle(f),c.setId(a.id),y.getSource().addFeature(c),c}},Ba=function(){var a={service:"ejb/TraceLocal",method:"getTraceTypes"};m.getGSSRequest(a,Da,Ca)},Ca=function(b){a.publish("raiseStickyMessage",[e.trace.traceTypesFailure,{messageType:"warning",errorMessage:b.responseText}])},Da=function(c){var d=Ea(c);b.each(d.trace_types,function(b){H[b.name]=b,H[b.name].nodes={},H[b.name].icons=a.extend(!0,{},J),H.trace_array.push(b)}),V()},Ea=function(a){var c={},d="trace_types";if(f.settings){if(b.contains(f.settings[d],"all"))return a;var e=[];f.settings[d]&&(b.map(a[d],function(a,c){b.contains(f.settings[d],a.name)&&e.push(a)}),c[d]=e)}else c=a;return c},Fa=function(){a.publish("clearTraceResult")},Ga={};return Ga.__TEST_ONLY__={setSpinner:function(a){z=a},highlightInvalidMarkers:ba,setCardSelector:function(a){u=a},getCardSelector:function(){return u},getOlMap:function(){return v},setOlMap:function(a){v=a},getOlMapName:function(){return w},setTags:function(a){G=a},setTraces:function(a){H=a},getTraces:function(){return H},initTraceNodes:oa,setTracePoint:O,getTraceTypes:Ba,getTraceTypesCallback:Da,clearClick:X,setTraceLayer:function(a){A=a},setResultsList:function(a){x=a},getResultsList:function(){return x},getTraceLayer:function(){return A},finalizeClick:Z,traceErrorCallback:aa,getTraceResultCallback:da,startClickControl:ea,getSelectedNodeType:function(){return I},setSelectedNodeType:function(a){I=a},getMarkers:function(){return y},checkForSelectedNode:ua,removeSingleItemClick:sa,stubSetTracePoint:function(a){O=a},setMarkers:function(a){y=a},stubClearTrace:function(a){return Y=a,a}},Ga});