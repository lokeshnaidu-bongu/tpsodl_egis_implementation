/*! ElectricOfficeWeb 5.0.1 2021-06-16 */
define(["jquery","underscore","OpenLayers3","hogan","download","map-helper","text!plotting-partials/plotting.html","text!plotting-partials/custom_text.html","i18n!viewer/nls/messages","map-loader","comms","text!viewer-icons/icon-tip.svg","spinner","map-core-component/pubsub"],function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";function m(a){setTimeout(n,0,a)}function n(b){var c=b.offsetHeight-b.clientHeight;a(b).height(0).height(b.scrollHeight-c)}var o,p,q,r,s,t,u,v,w,x,y,z,A,B=d.compile(g),C=d.compile('{{#types}}<option value="{{type}}">{{#display_name}}{{display_name}}{{/display_name}}{{^display_name}}{{type}}{{/display_name}}</option>{{/types}}'),D=d.compile('{{#scales}}<option value="{{scale}}"{{#defaultScale}} selected{{/defaultScale}}>1:{{scale}}</option>{{/scales}}'),E=d.compile(h),F="plotting",G=300,H=0,I=2,J=2500,K={layout_type:"test",bounds:"",view_scale:J,async:!0,json:!0},L={service:"ejb/AdminLocal",method:"getResult",request_id:void 0,session_id:void 0,json:!0},M={service:"ejb/WebPlotLocal",method:"layout_types",json:!0},N={type_array:[]},O={visited_geoms:[]},P=j.style||{tracing:{}},Q={ROTATE:0,NONE:1},R={present:!1,selected:!1,actionToPerfom:Q.NONE,centrePx:[],angle:0,interactions:[],geometry:void 0},S=f.getMapProjection(),T=function(){a.subscribe("sidebarContainerReady",X),a.subscribe("mapInitialised",Y),a.subscribe("setTraceResult",function(a){O=a}),a.subscribe("clearTraceResult",function(){O.visited_geoms=[]}),a.subscribe("leavingSidebar",function(b){b===F&&(a.publish("activateSketching",[]),ya(),wa(),U(s))}),a.subscribe("gotoSidebar",function(b){if(b===F){var c=o.val(),d=p.val();ta(s,S),a.publish("deactivateSketching",[]),ua(s),c&&(ya(),wa(),va(N[c],d),xa()),V(s)}}),a.subscribe("mapSelectionFired",function(){"none"!==a("#plotting-container").css("display")&&V(s)})},U=function(a){if(a){var b=Xa(),c=Ya();b&&(c?b.setZIndex(parseInt(c.getZIndex()-10)):b.setZIndex(r))}},V=function(a){if(a){var c=Xa(),d=f.getMapLayers(),e=0;c&&(b.each(d,function(a){a.getZIndex()>e&&(e=a.getZIndex())}),r||(r=c.getZIndex()),e=parseInt(e)+10,c.setZIndex(e))}},W=function(){var a=o.val();if(!a)return!1;var b=N[a];return!!b&&b.needsToShowViewPort},X=function(b,c){b===F&&($(R),t=c,t.html(B.render({messages:i,TipSvg:l})),v=a(t[0]).find("button#plot"),w=a(t[0]).find("button#reset"),o=a(t[0]).find("#plotLayoutType"),p=a(t[0]).find("#plotLayoutScale"),q=a(t[0]).find("#plotCustomTexts"),x=a(t[0]).find("#spinner"),u=a(t[0]).find("div#plots ul"),v.on("click touchend",Za),w.on("click touchend",Ja),Ca())},Y=function(a,b){s=b,bb()},Z=function(){var a=[],b=new c.style.Fill({color:[88,172,250,.3]}),d=new c.style.Stroke({color:[0,128,255,.3],width:4});return a.push(new c.style.Style({fill:b,stroke:d})),a},$=function(a){a.present=!1,a.actionToPerfom=Q.NONE,a.centrePx=[],a.angle=0,a.interactions=[],a.geometry=void 0},_=function(a){a.selected=!0},aa=function(a){a.selected=!1},ba=function(a,c){b.each(c.interactions,function(b){a.removeInteraction(b)}),c.interactions=[]},ca=function(a){return a.interactions&&a.interactions.length>0},da=function(a,b,c){c&&(b.interactions||(b.interactions=[]),b.interactions.push(c),a.addInteraction(c))},ea=function(a,b,c,d){ia(a,b,d),b.angle=0,b.angle=ja(b,c),b.actionToPerfom=Q.ROTATE},fa=function(a,b,c,d){var e;b.present&&b.actionToPerfom!==Q.NONE&&b.actionToPerfom===Q.ROTATE&&(ia(a,b,d),e=ja(b,c),ga(a,b,e),b.angle+=e)},ga=function(a,b,c){b.geometry.applyTransform(ha(a,b.centrePx,c))},ha=function(a,b,c){return function(a,d,e){for(var g,h,i,j,k=Math.cos(c),l=Math.sin(c),m=0;m<a.length;m+=e)g=f.getPixelFromCoordinate([a[m],a[m+1]]),h=g[0]-b[0],i=b[1]-g[1],j=f.getCoordinateFromPixel([b[0]+(h*k-i*l),b[1]-(h*l+i*k)]),d[m]=j[0],d[m+1]=j[1];return d}},ia=function(a,b,c){var d=c||Wa(a),e=Sa(d);b.geometry=d.getGeometry(),b.centrePx=Qa(e)},ja=function(a,b){var c=f.getPixelFromCoordinate(b),d=a.centrePx,e=c[0]-d[0],g=d[1]-c[1],h=Math.atan2(g,e)-a.angle;return h},ka=function(a,b){var d=Z(),e=b||Wa(a),f=Sa(e),g=new c.style.Icon({src:"lib/plot/partials/icons/anchor_dot.svg",size:[24,24],imgSize:[24,24],scale:1.3,opacity:.75}),h=new c.style.Icon({src:"lib/plot/partials/icons/ico_rotate_sm2.svg",size:[20,22],imgSize:[20,22],opacity:.75,scale:.6}),i=new c.style.Icon({src:"lib/plot/partials/icons/ico_panarrow_sm2.svg",size:[24,24],imgSize:[24,24],opacity:.75,scale:.6}),j=Oa(a,f);if(j){sa(j,d,g,i);for(var k=0;k<4;k++)la(f[k],d,g,h)}return d},la=function(a,b,d,e){var f=new c.style.Style({image:d,geometry:new c.geom.Point(a)});return b.push(f),f=new c.style.Style({image:e,geometry:new c.geom.Point(a)}),b.push(f),b},ma=function(a,b){return function(c){return!(!a.selected||pa(s,c.coordinate,20,b)!==Q.ROTATE)&&(ea(s,a,c.coordinate,b),!0)}},na=function(a,b){return function(c){fa(s,a,c.coordinate,b)}},oa=function(a){return function(b){return a.actionToPerfom=Q.NONE,!1}},pa=function(a,b,c,d){var e=d||Wa(a),f=Sa(e);return b&&c&&qa(b,f,c)?Q.ROTATE:Q.NONE},qa=function(a,b,c){for(var d=0;d<b.length;d++)if(ra(a,b[d],c))return!0;return!1},ra=function(a,b,c){var d,e,g,h;return!(!a||!b)&&(d=f.getPixelFromCoordinate(a),e=f.getPixelFromCoordinate(b),g=e[0]-d[0],h=e[1]-d[1],Math.pow(g,2)+Math.pow(h,2)<=Math.pow(c,2))},sa=function(a,b,d,e){var f=new c.style.Style({image:d,geometry:new c.geom.Point(a)});return b.push(f),f=new c.style.Style({image:e,geometry:new c.geom.Point(a)}),b.push(f),b},ta=function(b,d){var e="Plot Guide",g=new c.source.Vector({}),h=new c.layer.Vector({source:g,extent:d.maxExtent,maxResolution:d.maxResolution,renderOrder:null,visible:!0,name:e,style:Z()});g.name=e,b.addLayer(h),a.publish("registerSpecialSelectionHandler",[e,function(){f.setContinueSelecting(!1)}])},ua=function(a){var b,d,e,f;ca(R)||(f=Xa(),b=new c.interaction.Select({layers:[f],style:function(){return ka(s)},id:"plotBoxSelectControl"}),da(a,R,b),b.on("select",function(a){a.selected.length>0?_(R):aa(R)}),d=new c.interaction.Translate({features:b.getFeatures(),id:"plotBoxTranslate"}),da(a,R,d),e=new c.interaction.Pointer({handleDownEvent:ma(R),handleDragEvent:na(R),handleUpEvent:oa(R),id:"plotBoxRotate"}),da(a,R,e))},va=function(a,b){var d,e,f,g=!1,h=[];if($(R),a){if(g=a.needsToShowViewPort,w){if(!g)return void w.hide();w.show()}d=Aa(s,a,b),h.push(new c.geom.Polygon([d]));for(var i=0;i<4;i++)h.push(new c.geom.Point(d[i]));d=Ba(s,d),h.push(new c.geom.MultiLineString([d])),e=new c.geom.GeometryCollection(h),f=new c.Feature({geometry:e,name:"PlotBox"}),Xa().getSource().addFeature(f),ua(s),R.present=!0}},wa=function(){v[0].disabled=!0},xa=function(){v[0].disabled=!1},ya=function(){var a=Xa(),b=Wa(s);ba(s,R),b&&a.getSource().removeFeature(b)},za=function(a,b,c){var d=c,e=72/2.54,g=100;return!d&&b.scale&&(d=b.scale[0]),d||(d=Math.round(f.getMapResolution()*g*e)),d},Aa=function(a,b,c){var d,e,g,h,i,j,k,l,m,n=[],o=f.getNumberOfMetersPerPixel(),p=1e4;return l=f.getCurrentMapCentre(a),m=f.getPixelFromCoordinate(l),j=b.viewportWidth[0],k=b.viewportHeight[0],d=za(a,b,c),j&&k||(j=1750,k=2870),d?(e=d*(k/p),g=d*(j/p)):(e=J*(k/p),g=J*(j/p)),i=g/o,h=e/o,i/=2,h/=2,n[0]=[m[0]-i,m[1]+h],n[1]=[m[0]-i,m[1]-h],n[2]=[m[0]+i,m[1]-h],n[3]=[m[0]+i,m[1]+h],f.getCoordinatesFromPixelList(n)},Ba=function(a,b){var c,d=[],e=[];return d[0]=b[0],d[1]=b[1],d[3]=b[3],c=Math.floor(.05*Math.abs(d[0][1]-d[1][1])),d[0][1]=d[0][1]-c,d[3][1]=d[3][1]-c,e[0]=d[0],e[1]=d[3],e},Ca=function(){k.getGSSRequest(M,Da,La)},Da=function(a){N=Ea(a,j),o.append(C.render({types:N.type_array})).change(Ha).trigger("change")},Ea=function(a,c){var d={type_array:[]},e=Ga(a,c);return b.each(e.layout_types,function(a,b){d[b]={type:b,scale:a.view_scale,viewportHeight:a.primary_viewport_height,viewportWidth:a.primary_viewport_width,needsToShowViewPort:Fa(a.geometry_source,c),usesInternal:void 0!==a.details_template,attributes:a.attributes},d.type_array.push({type:b,display_name:a.display_name?a.display_name[H]:void 0})}),d},Fa=function(a,c){if(!a||!c.plotting)return!1;var d=a[0];return!!b.contains(c.plotting.hasViewPort,d)||(b.contains(c.plotting.hasNotViewPort,d),!1)},Ga=function(c,d){var e={},f="layout_types",g=d;if(e=a.extend(!0,{},c),g.settings){if(e[f]={},b.contains(g.settings[f],"all"))return c;var h={};g.settings[f]&&(b.each(c[f],function(a,c){b.contains(g.settings[f],c)&&(h[c]=a)}),e[f]=h)}else e=c;return e},Ha=function(b){var c,d,e=a(this),f=e.val();f&&(c=N[f].scale)?Ia(c[I],c[H]):(p.empty(),p.hide()),d=N[f].attributes,q.html(E.render({attributes:d})),q.find("TextArea").trigger("change").tooltip(),Ka()},Ia=function(a,c){var d=[],e=!1;p.show(),a?b.each(a,function(a){e=!(!c||a!==c),d.push({scale:a,defaultScale:e})}):d.push({scale:c,defaultScale:!0}),p.html(D.render({scales:d})).change(Ja).trigger("change")},Ja=function(a){Ka()},Ka=function(){var b,c;a("#plotting-container").is(":visible")&&(b=o.val(),c=p.val(),b&&(ya(),wa(),va(N[b],c),xa()))},La=function(b){a.publish("raiseStickyMessage",[i.plotting.plotFailed,{messageType:"error",errorMessage:b.responseText}]),jb(),W()||xa()},Ma=function(a,b,c){var d,e,f,g,h,i=Na(a,b,c),j=i.topRight,k=i.topLeft,l=i.bottomRight,m=i.centre;return d=Math.floor(Math.sqrt(Math.pow(j[0]-l[0],2)+Math.pow(j[1]-l[1],2))),e=Math.floor(Math.sqrt(Math.pow(j[0]-k[0],2)+Math.pow(j[1]-k[1],2))),f=Math.atan2(m[1]-j[1],j[0]-m[0]),g=Math.atan(d/e),h=(f-g)*(180/Math.PI),h=Math.round(h)},Na=function(a,b,c){var d=f.getPixelFromCoordinate(b[2]),e=f.getPixelFromCoordinate(b[1]),g=f.getPixelFromCoordinate(b[0]),h=f.getPixelFromCoordinate(b[3]),i=f.getPixelFromCoordinate(c);return{topRight:d,topLeft:e,bottomLeft:g,bottomRight:h,centre:i}},Oa=function(a,b){var c;if(b)return c=Qa(b),Pa(c)},Pa=function(a){return f.getCoordinateFromPixel(a)},Qa=function(a){var b,c;if(a)return b=f.getPixelFromCoordinate(a[0]),c=f.getPixelFromCoordinate(a[2]),[(b[0]+c[0])/2,(b[1]+c[1])/2]},Ra=function(){K.layout_type=void 0,K.bounds=void 0,K.crs=void 0,K.centre=void 0,K.rotation=0,K.view_scale=0,K.overlay=void 0,K.attributes=void 0,K.layers=void 0},Sa=function(a){if(a)return Ta(a.getGeometry())},Ta=function(a){if(a)return a.getGeometries()[0].getCoordinates()[0]},Ua=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e=d?d.get("InternalLayerName")||f.getLayerName(d):null;e&&"Plot Guide"!==e&&f.getVisibility(d)&&b.push(e)}return b.join(",")},Va=function(a,b,c,d,e,g,h){var i,k;return Ra(),K.layout_type=d,K.crs=c.name,e.needsToShowViewPort?(K.bounds=void 0,k=Sa(b),i=Oa(a,k),K.centre=i[0]+","+i[1],K.rotation=Ma(a,k,i)||0):(k=f.getMapBounds(a),K.bounds=""+k[0]+","+k[1]+","+k[2]+","+k[3]),K.view_scale=za(a,e,g),K.attributes=JSON.stringify(h),j.isAvailable("trace")&&(K.overlay=_a()),K.layers=Ua(a.getLayers().getArray()),K},Wa=function(){var a,b=Xa();return b&&b.getSource().getFeatures().forEach(function(b){"PlotBox"===b.get("name")&&(a=b)}),a},Xa=function(){return f.getLayerByName("Plot Guide")},Ya=function(){return f.getLayerByName("Sketch Layer")},Za=function(){var a,b,c;db()&&(b=o.val(),a=N[b],a&&(c=p.val(),Va(s,Wa(s),S,b,a,c,$a(a)),k.postGSSRequest(K,"?service=ejb%2FWebPlotLocal&method=web_pdf_plot",eb,La),ib()))},$a=function(a){var c={};return b.each(a.attributes,function(a){var b=document.getElementById("custom_text_"+a.name);c[a.name]=b.value}),c},_a=function(){var a,d={};return b.each(O.visited_geoms,function(e,g){var h=[];b.each(e,function(a){h.push(ab(a))}),(f.isGeographicWorld(g)||N[K.layout_type].usesInternal)&&(a=new c.format.GeoJSON,d[g]=JSON.parse(a.writeFeatures(h)))}),JSON.stringify(d)},ab=function(a){var b=f.parseData([{coordinates:a.coordinates,type:"LineString"}]),c=b[0];return c.setProperties(cb()),c},bb=function(){var a=b.extend({strokeWidth:5,strokeColor:"#ff9900"},P.tracing),d={type:"line",width:a.strokeWidth,colourRgb:a.strokeColor,stroke:"solid",dashPattern:"none"},e=c.color.asArray(d.colourRgb),f=e.slice(0,3),g=f.map(function(a){var b=a.toString(16);return b.length<2?"0"+b:b});A=d,A.colourRgb="#"+g[0]+g[1]+g[2]},cb=function(){return A},db=function(){return!!o.val()||(o.addInlineHelp("error",i.plotting.layoutNotSelected),!1)},eb=function(b){b.session_id&&b.request_id&&(y=b.session_id,z=b.request_id,fb(),a.publish("raiseTempMessage",[i.plotting.plotStarted,{messageType:"info"}]),ya(),wa())},fb=function(){var a=b.extend({},L,{request_id:z,session_id:y});k.getGSSRequest(a,gb,La,{cache:!1})},gb=function(c){c.resources?(a.publish("raiseTempMessage",[i.plotting.plotComplete,{messageType:"success"}]),b.each(c.resources,function(a){hb(a)})):window.setTimeout(function(){fb(y,z)},G)},hb=function(b){var c=/^.*\/\/.*?(\/(gss|resource).*)$/.exec(b),d=/plot\/(.*pdf)/.exec(b),f=new XMLHttpRequest;if(f.open("GET",c[1],!0),!k.isUnauthenticatedApp()){var g=k.getBearerToken();f.setRequestHeader("Authorization","Bearer "+g)}f.responseType="blob",f.onload=function(){if(200===f.status){var b=d[1],c=new Blob([f.response],{type:"application/pdf"});a.publish("clientItemReadyForDownload",[{type:e.fileTypes.PDF,blob:c,fileName:b,title:i.plotting.downloadTitle.replace("$1",a(":selected",o).text()),date:new Date}])}},f.send(),jb(),W()||xa()},ib=function(){x.spin(),wa()},jb=function(){x.spin(!1)};T(),a(document.body).on("keydown.textarea keyup.textarea",".sw-auto-resize",function(a){m(this)}).on("change.textarea",".sw-auto-resize",function(a){n(this)});var kb={addLayers:ta,getPlotBoxBounds:Sa,getPlotBoxAngle:Ma,getPlotBoxCentre:Oa,getLayerStyle:Z,workOutScale:za,workOutUnderlyingLine:Ba,rotateTransform:ha,applyWhenMouseDown:ma,applyWhenMouseUp:oa,applyWhenMouseDrag:na,getViewPortStyle:ka,removeViewportInteractions:ba,needsToShowViewPort:Fa};return kb.__TEST_ONLY__={getLayoutTypesList:Ea,workOutPlotSize:Aa,workOutPlotCharacteristics:Va,getCustomTextData:$a,initialise:X,getLayoutTypes:Ca,layoutTypesCallback:Da,handleSelectLayoutChange:Ha,setupScaleSelect:Ia,errorCallback:La,startPlot:Za,validateForm:db,plotCallback:eb,pollForResult:fb,pollCallback:gb,downloadPlot:hb,spinOn:ib,spinOff:jb,lowerPlotLayer:U,raisePlotLayer:V,getMap:function(){return s},setMap:function(a){s=a},setTimeout:function(a){G=a},setButtonSelector:function(a){v=a},setTypeSelector:function(a){o=a},setScaleSelector:function(a){p=a},setSpinSelector:function(a){x=a},setPlotListSelector:function(a){u=a},getPlotOptions:function(){return K},getTraceStyle:cb,initTraceStyle:bb,setTraceResults:function(a){O=a}},kb});