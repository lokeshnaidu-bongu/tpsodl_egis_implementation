/*! ElectricOfficeWeb 5.0.1 2021-06-16 */
define(["date-helper","jquery","underscore","i18n!viewer/nls/messages","text!object-details-partials/object-info.html","text!object-details-partials/relatedDocPopover-textarea.html","hogan","comms","map-loader","map-helper","link-creator","map-core-component/pubsub"],function(a,b,c,d,e,f,g,h,i,j,k){"use strict";var l,m="object_info",n=g.compile(e),o=g.compile(f),p={},q=function(){b.subscribe("objectDetailsBoxReady",function(a,b){a===m&&r(b,{id:a})}),b.subscribe("showObjectDetails",function(a){u(a),b(".ol-overlay-container .popover").remove()}),b.subscribe("leavingSidebar",x)},r=function(a){l=a,t()},s=function(){l.html(""),l.hide()},t=function(a){l.show(),l.html(n.render({feature:a,messages:d})),b("div.join",l).click(function(){b.publish("showObjectDetails",[{urn:this.id}])}),b(".link").on("click",function(){b("#object_details-container .popover").remove();var a=b(this);a.popover({html:!0,content:o.render({message:d.object_details.relatedDocumentsMessage,value:a[0].getAttribute("data-filename")}),placement:"top",container:"#object_details-container",trigger:"manual"}),a.popover("show"),b("#docFilePath").select(),b("#link-popover #popupClose").on("click",function(){a.popover("hide"),b(this).closest(".popover").remove()})})},u=function(a){var b=a.urn;if(s(),p[b])return void y(p[b],b);var c={service:"ejb/ObjectInfoLocal",method:"info",crs:"EPSG:900913",objects:b,json:!0,return_info:i.ObjectDetails.return_info||"all_joined_objects,related_documents_details",result_type:"all",format_fields:!0,ace_visibility_tag:i.tags.objectDetails||"web_export"};h.getGSSRequest(c,function(a){p[b]=a,y(a,b)},function(a,b,c){console.log(a,b,c),s()})},v=function(a){return k.isHttpRequest(a)?k.makeHttpLink({url:a,description:a}):a},w=function(a){var b=null;return k.isHttpRequest(a.full_file_name)?b=k.makeHttpLink({url:a.full_file_name,description:a.description||a.full_file_name}):a.full_file_name&&(b=k.makeFileLink({path:a.full_file_name,description:a.description||a.full_file_name})),b},x=function(){b("#object_details-container .popover").remove()},y=function(e,f){var g=e.object_info[f].feature.features[0],h=e.object_info[f].all_joined_objects.features,j=e.object_info[f].related_documents_details,k=e.object_info[f].feature.features[0].name,l=[];g.attributes=[],c.each(g.properties,function(a,d){var e,f,j=[],l=d in h;"unset"!==a&&""!==a&&null!==a&&(l&&c.each(h[d],function(a){j.push({name:a.name,urn:a.urn})}),e=k+"."+d,i.AttributeHandlers&&(f=i.AttributeHandlers[e]),f?b.publish(f,[a,function(a){g.attributes.push({value:a,attrib:d,joins:j})}]):l?j.length&&g.attributes.push({value:"",attrib:d,joins:j}):g.attributes.push({value:b("<div/>").html(v(a)).text(),attrib:d,joins:j}))}),c.each(j,function(a,c){var d;"unset"!==a&&""!==a&&null!==a&&(d=w(a),null!==d&&(l[c]=b("<div/>").html(d).text()))}),l.length>0&&g.attributes.push({attrib:d.object_details.relatedDocumentsSection,value:l.join(" ")}),e=JSON.parse(JSON.stringify(e,a.formatISODateString)),g=JSON.parse(JSON.stringify(g,a.formatISODateString)),b.publish("objectInfoCallback",[e,f]),t(g)};q();var z={};return z.__TEST_ONLY__={initialise:r,clearUI:s,getBoxSelector:function(){return l},setBoxSelector:function(a){l=a},objectInfoRequest:u,setCache:function(a){p=a},getCache:function(){return p},formatRelatedDocumentLink:w},z});