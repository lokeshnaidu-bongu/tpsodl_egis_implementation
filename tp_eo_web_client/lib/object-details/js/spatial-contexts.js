/*! ElectricOfficeWeb 5.0.1 2021-06-16 */
define(["jquery","underscore","OpenLayers3","i18n!viewer/nls/messages","text!object-details-partials/spatialContexts.html","hogan","comms","map","map-helper","map-loader","map-core-component/pubsub"],function(a,b,c,d,e,f,g,h,i,j){"use strict";var k,l,m,n,o=f.compile(e),p="spatial_contexts",q=i.getMapProjection(),r=[],s={},t=function(){a.subscribe("objectDetailsBoxReady",function(a,b){a===p&&u(b)}),a.subscribe("showObjectDetails",function(a){a.urn&&a.urn!==m&&v(a.urn)})},u=function(a){var b={messages:d};a.html(o.render(b)),a.show()},v=function(b){m=b;var c={service:"ejb/ObjectInfoLocal",method:"spatialContexts",objects:b,json:!0,result_type:"all"};k=a("#spatialContextsContainer"),k.empty(),g.getGSSRequest(c,w,G)},w=function(a){var c=a.object_info,d=c[Object.keys(c)[0]].spatial_contexts;r=[],b.each(d,function(a){r.push(a)}),x(r,k)},x=function(c,e){var f,g,h;c.length<1&&e.append("<div>"+d.spatial_contexts.noContext+"</div>"),b.each(c,function(c,d){f=c.spatialContextElements,b.isEmpty(f)||(g=Object.keys(f)[0],h=i.getObjectFromUrn(f[g]).sc_name,h=y(h),r[d].contextName=h,b.contains(j.ObjectDetails.visible_spatial_contexts,h)&&(e.append('<a href="#" id="spatialLink'+d+'" >'+r[d].name+"</a>"),e.append("</br>"),a("#spatialLink"+d).click(function(){z(m,r[d].contextName),n=d})))})},y=function(a){return a=a.replace(/J4a-/g,"J"),a=a.replace(/J51-/g,"Q"),a=a.replace(/J56-/g,"V"),a=a.replace(/J58-/g,"X"),a=a.replace(/J5a-/g,"Z"),a=a.replace(/-/g,""),a=a.replace(/002d/g,"-"),a=a.replace(/0020/g," "),a=a.replace(/0028/g,"("),a=a.replace(/0029/g,")"),a=a.replace(/003c/g,"<"),a=a.replace(/003d/g,"="),a=a.replace(/003e/g,">")},z=function(a,b){var c,d;m=a,c=h.findMatchingWorldAndContext(j.Layers.AdditionalWorlds,"",b),d={service:"ejb/WorldInfoLocal",method:"spatialContextForObject",object_urn:a,context_name:b,json:!0,crs:c.ProjectionName||"EPSG:3857"},g.getGSSRequest(d,A,G)},A=function(a){var b=Object.keys(a.spatial_context)[0];!b||i.isGeographicWorld(b)?D(m,"geographic_context"):B(a,b)},B=function(b,c){var d,e,f={},g={};d=F(b,c),g=i.getObjectFromUrn(c),e=g.dataset+"_"+g.universe+"_"+g.world,b.worldDescription=e,s=b,f.theme=null,f.projection="EPSG:3857",f.units="m",f.numberOfZoomLevels=100,f.defaultZoom=15,f.maxExtent=[-2147483647,-2147483647,2147483647,2147483647],f.urn=m,f.worldDescription=e,f.mapData=b,f.contexts={},f.contexts[b.context_name]=b.context_name,f.content=h.createMap(f),f.content.name=r[n].name,a.publish("triggerOverlay",[f]),a("#overlay").modal("toggle"),f.content.updateSize(),E(f.content,d,b,c),b.context_name.indexOf("schematic")!==-1&&C(b,c),l=f.content},C=function(b,c){var d=[];if(b.spatial_context[c].forEach(function(a){var b=i.parseData([a])[0];b&&d.push(b)}),a.publish("highlightFeatures",["overlay",d]),"Geo-schematic"===b.context_name)if(j.Layers.Google){i.createGoogleLayerForMap(overlayMap,"overlayGmap",7)}else overlayMap.getLayers().insertAt(0,olMapInstance.olMap.getLayers().getArray()[0]),overlayMap.updateSize()},D=function(b,c){var d={service:"ejb/ObjectInfoLocal",method:"info",json:!0,crs:q.name,objects:b,return_info:c,result_type:"all",format_fields:!0};g.getGSSRequest(d,function(c){a.publish("removeOverlay"),a.publish("gotoServerAsset",[c,"main_map",b])},G)},E=function(a,b,c,d){i.gotoExtentsOfFeatures(a,i.parseData(c.spatial_context[d]))},F=function(a,b){var c,d;if(a.spatial_context[b])return c=a.spatial_context[b][0].location,d=c?0:1,1!==d||a.spatial_context[b][1]||(d=0),d},G=function(a,b,c){console.log(a,b,c)};t();var H={};return H.__TEST_ONLY__={getContexts:v,getFeatures:z,addContextsToPanel:x,getFeaturesCallback:A,getContextsDataCallback:w,getReturnedContexts:function(){return r},getReturnedFeatures:function(){return s},getMapDiv:function(){return l},setObjectIndex:function(a){n=a}},H});