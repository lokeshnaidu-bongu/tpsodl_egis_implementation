/*! ElectricOfficeWeb 5.0.1 2021-06-16 */
define(["jquery","underscore","OpenLayers3","map-helper","i18n!viewer/nls/messages","map-loader","hogan","comms","popovers","window-manager","map-core-component/pubsub"],function(a,b,c,d,e,f,g,h,i,j){"use strict";var k,l,m,n,o,p,q=(b.extend({strokeWidth:5,strokeOpacity:.75,strokeColor:"#ff9900",pointRadius:10}),function(){}),r=function(b){var c,d=a('<div id="genericMapContainer" class="olMap map" data-urn="'+b.urn+'" style="width:100%; height:100%; min-width:50px; min-height:50px;"></div>');return o=null,n=b.projection,k=b.worldDescription,b.mapData?(b.additionalWorldsConfig=f.Layers.AdditionalWorlds||[],b.geoms_bounds=b.mapData.geoms_bounds,o=t(d,b),C(b),l=b.urn,b.geoms_bounds&&z(b.geoms_bounds)):B(b.urn,!1),c=t(d,b),H(),window.overlayMap=c,c},s=function(a){l&&m&&B(l,!0)},t=function(a,b){return o?o:(o=u(a,b),o.on("moveend",s),o)},u=function(a,b){var d,e,f,g={};return b.contexts&&(b.contextName=Object.keys(b.contexts)[0]),b.contextName?g=v(b.additionalWorldsConfig,b.worldDescription,b.contextName):g.maxResolution=null,d=new c.View({center:b.center||[0,0],zoom:b.defaultZoom||15,maxResolution:g.maxResolution||16777215.9921875,maxZoom:g.ZoomLevels||21,projection:b.projection||"EPSG:900913"}),d.setProperties({maxZoom:g.ZoomLevels||b.numberOfZoomLevels||21}),b.interactions&&b.interactions.length>0?e=new c.Collection(b.interactions):(e=c.interaction.defaults({altShiftDragRotate:!1,dragPan:!1,pinchRotate:!1}),e.push(new c.interaction.DragPan({kinetic:new c.Kinetic((-.03),.05,100)}))),f=new c.Map({target:a[0],layers:[],units:b.units||"m",interactions:e,view:d,controls:[]}),f.maxExtent=b.maxExtent,f},v=function(a,b,c){for(var d,e,f=0;f<a.length;f++)if(d=new RegExp(a[f].WorldDescription),e=new RegExp(a[f].SpatialContextName),(!b||d.test(b))&&(!c||e.test(c)))return a[f];return{}},w=function(a,b,d){for(var e=c.extent.getWidth(b)/d,f=new Array(a),g=new Array(a),h=0;h<a;++h)g[h]=h,f[h]=e/Math.pow(2,h);return{matrixIds:g,resolutions:f}},x=function(a){var b,d,e=a.additionalWorldsConfig,f=a.worldDescription,g=a.contextName,i=v(e,f,g),j=i.ZoomLevels,k=i.InternalLayerName||"Internals",l=i.TileSize||256,m=i.ProjectionName||a.projection,n=i.MaxExtent||a.maxExtent,q=(i.Units||"m",w(j,n,l)),r=a.olMapRef||o;return i.ZoomLevels&&r&&r.getView().setProperties({maxZoom:j}),b=new c.tilegrid.WMTS({matrixIds:q.matrixIds,resolutions:q.resolutions,tileSize:[l,l],extent:n,origin:c.extent.getTopLeft(n)}),d=new c.layer.Tile({style:"",opacity:1,visible:!0,extent:n,source:new c.source.WMTS({dimensions:a.dimensions,layer:k,style:"",attributions:[],url:"/maps",matrixSet:f,format:"image/png",projection:m,tileGrid:b,tileLoadFunction:h.customLoader})}),p=d,d.setProperties({layerCRS:m}),d},y=function(a,b,c){o.updateSize(),o.removeLayer(a),b&&o.addLayer(b),c&&z(c),o.updateSize()},z=function(a){var b=A(a),e=c.extent.getCenter(a);o.getView().setCenter(e),o.getView().extent=b,d.fitMapToBounds(o,b)},A=function(a){var b=d.getBoundsSizes(a),c=b.height/2,e=b.width/2,f=a;return f[3]=f[3]+c,f[1]=f[1]-c,f[0]=f[0]-e,f[2]=f[2]+e,f},B=function(a,b){var c;l=a,c={service:"ejb/WorldInfoLocal",method:"internalRwos",urn:a,json:!0,result_type:"all",crs:n,ace_visibility_tag:f.tags.internals||"web_export",internal_world_filter_alias:f.internalWorldFilterAlias||"standard"},b||o||h.getGSSRequest(c,C,I)},C=function(a){var b,c=Object.keys(a.contexts||{}),d={worldDescription:k||a.world_description,contextName:c.length?c[0]:"",additionalWorldsConfig:f.Layers.AdditionalWorlds||[],maxExtent:o.maxExtent,dimensions:{cache_in_database:!1}};d.worldDescription&&(m=!1,b=x(d),y(p,b,a.geoms_bounds),p=b,m=!0,D())},D=function(){o.on("click",function(b){a.publish("clearHighlight",["overlay"]),a.publish("clearPopovers"),E(b)})},E=function(a){for(var b,d,e=a.frameState,f=e.viewState,g=f.resolution,h=e.layerStatesArray,i=h.length-1;i>=0;--i)b=h[i],b.visible&&g>=b.minResolution&&g<b.maxResolution&&(d=b.layer,d.getSource()instanceof c.source.WMTS&&F(d,a))},F=function(a,b){var e,g,i,k,l,m,p,q,r,s,t,u,v=b.coordinate,w=a.getSource();e=w.getTileGrid(),d.setBusyCursor(),g=e.getTileCoordForCoordAndResolution(v,o.getView().getResolution()),k=w.getTileUrlFunction(),l=k(g,c.has.DEVICE_PIXEL_RATIO,c.proj.get(n)),l=l.split("&cache_in_database=false")[0],m=l.split("TileCol=")[1].split("&")[0],p=l.split("TileRow=")[1],q=l.split("TileMatrix=")[1].split("&")[0],i=e.getTileCoordExtent(g),r=o.getPixelFromCoordinate([i[0],i[3]]),s=[Math.round(Math.abs(r[0]-b.pixel[0])),Math.round(Math.abs(r[1]-b.pixel[1]))],u=j.isTouchDevice()?f.touchPixelHitRadius||8:f.pixelHitRadius||5,t={url:w.getUrls()[0],service:"WMTS",layer:w.getLayer(),tilematrixset:w.getMatrixSet(),tileMatrix:Math.round(q),tilerow:p,tilecol:m,infoformat:"application/json",i:s[0],j:s[1],crs:a.getProperties().layerCRS||n,request:"GetFeatureInfo",version:"1.0.0",pixel_hit_radius:u},h.getNodeRequest(t,function(a){G(b,a)},function(a,b,c){console.log(a,b,c)})},G=function(b,c){var e,f,g="overlay";c.features.length>0&&(c.text=JSON.stringify(c),c.coordinate=b.coordinate,f=a.parseJSON(c.text),i.updatePopupAtPosition(c.coordinate,f,o,g),e=[{lonlat:c.coordinate,features:f,map:o,mapName:g}],a.publish("featureSelected",e)),d.clearBusyCursor()},H=function(){},I=function(a,b,c){console.log(a,b,c)};q();var J={createMap:r,getNewMap:u,getNewMapLayer:x,findMatchingWorldAndContext:v},K=function(){return o};return J.__TEST_ONLY__={errorCallback:I,getFeatureInfo:F,getOlMapInstance:K},J});