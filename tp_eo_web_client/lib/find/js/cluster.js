/*! ElectricOfficeWeb 5.0.1 2021-06-16 */
define(["jquery","underscore","text!results-list-partials/marker_normal.svg","results-list","popovers","map-markers","map-cluster","map-helper","OpenLayers","i18n!viewer/nls/messages","map-loader","text!find-partials/find.html","text!find-partials/pagination.html","hogan","comms","map-core-component/pubsub"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){"use strict";var p,q,r,s,t,u,v=n.compile(l),w=(n.compile(m),n.compile(c)),x="find-component-cluster",y={query_array:[]};a.subscribe("sidebarContainerReady",function(a,b){a===x&&A(b,{id:a})}),a.subscribe("mapInitialised",function(a,b){s=b,t=a});var z,A=function(a){p=a,B()},B=function(){a.ajax({url:"lib/sample_query_rail.json",success:C})},C=function(a){b.each(a.search_config,function(a){"fields_find_component"===a["class"]&&(y[a.name]=a,y.query_array.push(a))}),E()},D=function(a){console.log(a)},E=function(){var c={queries:y.query_array,messages:j};p.append(v.render(c)),b.each(y,function(c,d){"query_array"!==d&&(c.$selector=a(".module-body #findOptions #"+c.name+"-query",p),c.fieldObject={},b.each(c.fields,function(a){c.fieldObject[a.name]=a}))}),q=a(".query-options",p);var e=a(".module-body select#queryType",p);e.change(M),e.change(),1===y.query_array.length&&e.hide(),a("button#submit",p).click(F),a("button#cancel",p).click(G),a(".query-clear-btn",p).click(H),a("button#submit",p).click(),r=a("#find-results",p),u=d.getNewResultsList(r,s,t,x,D)},F=function(){I()},G=function(){var b=a(".module-body select#queryType",p).val();y[b].$selector.find("input,select").val(""),u&&u.clear(),a("#results-page-controls",p).html(""),g.updateClusters({features:[]})},H=function(){a(this).parent().parent().find("input,select").val("")},I=function(){var a={service:"ejb/QueryLocal",method:"browser",query:K(),json:!0,crs:"EPSG:900913",result_type:"all",feature_count:9999,feature_start:1};o.getGSSRequest(a,L,N)},J=!1,K=function(){var c=a(".module-body select#queryType",p).val(),d=y[c].$selector.find("input,select"),e=y[c],f="where ",g=0;return b.each(d,function(b){var c=a(b),d=c.val(),h=c.data("name"),i=e.fieldObject[h];d&&(g>0&&(f+="and "),f=i&&i.join_field_name?f+"all ("+h+" where "+i.join_field_name+' matches "'+d+'*")':f+h+' matches "'+d+'*" ',g+=1)}),g>0?(J=!0,f=e.collections.join(" and ")+" "+f):(J=!1,f=e.collections.join(" and ")),f},L=function(a){var c=a.features,d=!1;c.features&&"Cluster"===c.features[0].name&&(d=!0),z&&(s.removeLayer(z),z=void 0);var f=0;b.each(c.features,function(a){a.properties.count&&(f+=a.properties.count)});var g={getImageSvg:function(a){var c,d=40,e=40,f=0,g=J?"#46ad00":"#005cb9";return b.each(a.cluster,function(a){f+=a.data.count}),c="data:image/svg+xml;charset=utf-8;base64,"+btoa(w.render({height:e,width:d,text:f,fill:g}))},getImageDim:function(a){var c=0,d=40;return b.each(a.cluster,function(a){c+=a.data.count}),a.cluster&&(d+=320*(c/f)),d}},h=new i.StyleMap({"default":new i.Style({externalGraphic:"${getImageSvg}",graphicWidth:"${getImageDim}",graphicHeight:"${getImageDim}",fillOpacity:1,strokeWidth:1,strokeOpacity:1,graphicZIndex:1},{context:g})}),j=function(a){e.removePopup();var c=new i.LonLat(a.feature.geometry.x,a.feature.geometry.y);a.feature.features=a.feature.cluster,b.each(a.feature.features,function(a){a.properties||(a.properties={}),a.name||(a.name="Cluster"),a.attributes.filter&&(a.id=a.attributes.filter),b.extend(a.properties,a.properties,a.attributes)}),e.createPopup(c,a.feature,s,t)};z=new i.Layer.Vector("car clusters",{styleMap:h,strategies:[new i.Strategy.Cluster({distance:80})]});var k=new i.Format.GeoJSON,l=[],m=new i.Bounds;b.each(c.features,function(a){var b=k.parseFeature(a),c=new i.LonLat(b.geometry.x,b.geometry.y);m.extend(c),b.lonlat=c,l.push(b)}),s.addLayer(z),s.zoomToExtent(m),z.addFeatures(l);var n=new i.Control.SelectFeature(z,{hover:!1});s.addControl(n),n.activate(),z.events.on({featureselected:j})},M=function(){var b=a(this).val();q.hide(),y[b].$selector.show()},N=function(a,b,c){console.log(a,b,c)},O={};return O.__TEST_ONLY__={},O});