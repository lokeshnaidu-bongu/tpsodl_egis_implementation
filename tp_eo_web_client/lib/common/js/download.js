/*! ElectricOfficeWeb 5.0.1 2021-06-16 */
define(["jquery","underscore","hogan","filesaver","i18n!viewer/nls/messages","text!viewer-partials/download.html","map-core-component/pubsub"],function(a,b,c,d,e,f){"use strict";var g,h,i=c.compile(f),j="download",k=[],l={type:"text",title:"",date:new Date},m={type:"text",title:"client file",date:new Date},n={},o={EXCEL:"excel",PDF:"pdf",TEXT:"text"},p=function(){a.subscribe("sidebarContainerReady",function(a,b){a===j&&q(b)}),a.subscribe("itemReadyForDownload",v),a.subscribe("clientItemReadyForDownload",u),a.subscribe("serverItemReadyForDownload",v),a.subscribe("gotoSidebar",function(b){b===j&&a.publish("removeOverlay")})},q=function(a){g=a,r()},r=function(){b.each(k,function(a){a.date_time=s(a.date)}),g.html(i.render({messages:e,downloads:k})),h=a("div#downloadList",g),a("a.client-data",g).on("click",x)},s=function(a){var b,c=(new Date).toDateString();return b=a.toDateString()===c?e.download.today:a.toLocaleDateString(),e.download.dateTime.replace("$1",b).replace("$2",a.toLocaleTimeString())},t=function(){window.$downlist=h;var b=a("a:first",h)[0];b.click&&b.click()},u=function(a){var c=b.extend({clientId:a.date.getTime()||1},m,a);n[c.clientId]=c,w(c)},v=function(a){w(b.extend({},l,a))},w=function(a){k=[a].concat(k),r(),t()},x=function(a){var b=this.id,c=n[b],e=c.blob;if(!e){var f=c.data;e=new Blob([y(f)],{type:"application/octet-stream"})}d(e,c.fileName)},y=function(a){var b=new ArrayBuffer(a.length),c=new Uint8Array(b);a+="";for(var d=0;d!==a.length;++d)c[d]=255&a.charCodeAt(d);return b};p();var z={fileTypes:o};return z.__TEST_ONLY__={clientItemDownload:u,s2ab:y,addToDownloadList:w,serverItemDownload:v,initialise:q,getClientBlobs:function(){return n},setCardSelector:function(a){g=a},getDownloads:function(){return k}},z});