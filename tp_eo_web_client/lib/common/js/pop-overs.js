/*! ElectricOfficeWeb 5.0.1 2021-06-16 */
define(["jquery","underscore","map-loader","OpenLayers3","hogan","text!viewer-partials/popover.html","text!viewer-partials/popover-carousel.html","text!viewer-partials/popover-carousel-inner.html","i18n!viewer/nls/messages","map-helper","link-creator","bootstrap/popover","bootstrap/carousel","map-core-component/pubsub","drags"],function(a,b,c,d,e,f,g,h,i,j,k){"use strict";var l=a.fn.tooltip.Constructor.DEFAULTS.whiteList||{};l.header=[],l.footer=[],l.button=["rel","title","data-event","style"],l.table=[],l.tr=[],l.td=[],l.th=[],l.tbody=[],l.thead=[],l.i=["style"],l.div=["style","id","style","role"],l.textarea=["id","rows","cols"];var m,n,o,p=e.compile(g),q=e.compile(h,{asString:!1}),r=0,s=0,t=[],u={},v={element:a("#app-window"),template:g,html:!0,popoverType:"general-popover",isCarousel:!1,carousel:null,data:null,messages:i,parentComponent:"",placement:"left",container:"body",trigger:"manual",urn:null,whiteList:l},w=!0,x=function(){a.subscribe("searchTypeChanged",J),a.subscribe("clearPopovers",J),a.subscribe("enablePopovers",L),a.subscribe("disablePopovers",K),a.subscribe("beforePopupCreated",J),a.subscribe("afterPopupCreated",y)},y=function(){a(".popover").drags({parent:".popover",handle:".popup-title"})},z=function(b,c,d){b&&(p=e.compile(b)),c&&(q=e.compile(c)),d&&a.extend(!0,i,d)},A=function(){p=e.compile(g),q=e.compile(h)},B=function(a,c,d){b.each(a.object_info,function(a,b){var e=j.dataCentralGeometry([a.geographic_context[0]]),f=j.findCentrePointOfGeometry(e),g={features:a.feature};void 0!==f&&(j.setCurrentMapCentre(c,f),C(f,g,a.geographic_context,c,d,!0,b))})},C=function(b,c,d,e,f,g,h){o=e,n=f,a.publish("requestPopoverControls",[function(f){a.publish("beforePopupCreated"),I(b,e,p.render({messages:i,isCarousel:!1,popoverControlsTemplate:f})),a.publish("popoverOnAsset",[h]),M(O(c,!1,d),g),a.publish("afterPopupCreated")}])},D=function(b,c,d){var e=b.coordinate;return F(e,a.parseJSON(b.text),c,d),m},E=function(a,b,c,d){t&&0!==t.length?S(b):F(a,b,c,d)},F=function(b,c,d,e){w===!0&&(o=d,n=e,a.publish("clearHighlight",[n]),J(),c.features.length>0&&(0===t.length&&a.publish("requestPopoverControls",[function(a){var c=p.render({messages:i,isCarousel:!0,popoverControlsTemplate:a});I(b,d,c)}]),S(c)),a.publish("afterPopupCreated"))},G=function(b,c,d,e){o=d,n=e,c&&(I(b,d,p.render({messages:i,name:c.name})),a("#popover_spinner").spin())},H=function(c){var d;return c=b.extend(v,c),a.publish("requestPopoverControls",[function(a){c.element.popover({html:c.html,content:c.template.render({popoverType:c.popoverType,isCarousel:c.isCarousel,carousel:c.carousel,data:c.data,messages:c.messages,parentComponent:c.parentComponent,popoverControlsTemplate:a}),placement:c.placement,container:c.container,trigger:c.trigger})}]),d=function(d){var e=a("."+c.popoverType+" .panel-footer button"),f=c.data.geometry;b.each(e,function(b){var d=a(b),e=c.urn,g=d.data("event");a.publish("popoverButtonVisibilityControl",[d,e,f]),d.on("click",function(b){a.publish(g,[{urn:e,geometry:f,lonlat:c.data.geographicLonLat,objectType:c.data.name?c.data.name:c.data.properties.Type}])})})},c.element.popover().on("shown.bs.popover",function(){a("#overlay")[0]&&a(".popover.fade.left.in").css("z-index","1100"),c.urn&&d(c.element)}),c.toggleIn&&c.element.popover("toggle"),!0},I=function(b,c,e){o=c,J(),m=new d.Overlay({id:"smallworld",position:b,element:a('<div class="mapPopup" />').get(0),autoPan:!1}),c.addOverlay(m),a(".mapPopup").popover({animation:!0,html:!0,content:e,placement:"top"}),X(),Y(),aa(o,b,a(".popover"))},J=function(){void 0!==m&&(r=0,s=0,t=[],o.removeOverlay(m),m=void 0),a.publish("popoverCleared",[n])},K=function(){w=!1},L=function(a){w=!0},M=function(b,c){var d;a(".ol-overlay-container #popupInner .carousel-inner").html(b),Q(),d=a(".ol-overlay-container #popupInner .carousel-inner .item").first().addClass("active"),Z(d),$(a(".ol-overlay-container #popupInner .carousel-inner .item.active").data("id"),c)},N=function(a){return k.isHttpRequest(a)?k.makeHttpLink({url:a,description:a}):a},O=function(c,d,e){var f,g={features:[]};return b.each(c,function(c){b.each(c.features,function(c){f=[],b.each(c.properties,function(b,c){b&&f.push({attrib:c,value:a("<div/>").html(N(b)).text()})}),g.features.push({name:c.name,id:c.id,feature:f,geomType:null!==c.geometry?c.geometry.type:""}),u[c.id]=void 0!==e?e:c.geometry})}),g.features=g.features.sort(U),g.messages=i,q.render(g)},P=function(a){var c,d={features:[]};return b.each(a,function(a){b.each(a.objects,function(a,e){c=[],b.each(a,function(a){c.push({attrib:a.name,value:a.description})}),c.length>0&&d.features.push({name:e,feature:c})}),d.name=a.name}),q.render(d)},Q=function(){var b=a(".ol-overlay-container #popupInner").find(".item:first");a(".ol-overlay-container .panel-title h3").text(b.data("name")),b=a(".ol-overlay-container #popupInner").find(".item"),a(".ol-overlay-container .popover footer .secondary #recordCount").text("1/"+b.length)},R=function(a){T(a),M(P(t))},S=function(a){T(a),M(O(t,!1))},T=function(c){var d=a.extend(!0,{},c),e=[],f=[];b.each(t,function(a){b.each(a.features,function(a){e.push(a.id)})}),b.each(d.features,function(a){e.indexOf(a.id)===-1&&f.push(a)}),d.features=f,t.push(d)},U=function(a,b){function c(a){return"Point"===a||"MultiPoint"===a}function d(a){return"LineString"===a||"MultiLineString"===a}function e(a){return"Polygon"===a||"MultiPolygon"===a}var f,g;return f=a.geomType,g=b.geomType,f===g?0:c(f)&&(d(g)||e(g))?-1:d(f)&&e(g)?-1:1},V=function(a,b){var c=a.height(),d=a.width(),e=b.css("position");a.css("top",-c+"px"),a.css("left",-d/2+"px"),b.css("position",""),setTimeout(function(){b.css("position",e)},1)},W=function(){var b=a(this).find(".item"),c=a(this).find(".active"),d=b.index(c);a(".ol-overlay-container .panel-title h3").text(c.data("name")),a(".ol-overlay-container .popover footer .secondary #recordCount").text(d+1+"/"+b.length),Z(c),$(c.data("id")),a(this).carousel("pause")},X=function(){a("#popupInner").carousel("pause"),a(".mapPopup").popover("show"),V(a(".ol-overlay-container .popover"),a(".olMapViewport")),a(document).on("mouseleave",".carousel",function(){a(this).carousel("pause")}),a("#popupInner").on("slide.bs.carousel",W),a("#popupInner").on("slid.bs.carousel",W),a(".carousel-inner .item").first().addClass("active"),a("#recordPrev").click(function(){a("#popupInner").carousel("prev")}),a("#recordNext").click(function(){a("#popupInner").carousel("next")}),a("#popUpClose").click(function(){J()}),_(),Q()},Y=function(){if("ontouchstart"in window||navigator.maxTouchPoints){var b,c,d,e=a("#popupInner");e.on("touchstart",function(f){var g=a(".carousel-inner");b=g.height()-g.parent().height(),b<0&&(b=0),c=e.scrollTop(),d=f.originalEvent.touches[0].screenY}),e.on("touchmove",function(a){var f=a.originalEvent.touches[0].screenY,g=c+d-f;g>b?g=b:g<0&&(g=0),e.scrollTop()!==g&&e.scrollTop(g)})}},Z=function(c){var d=a(".ol-overlay-container .popover-content footer .primary button");b.each(d,function(b){var d=a(b),e=c.data("id");a.publish("popoverButtonVisibilityControl",[d,e,u[e]])})},$=function(b,c){var d,e,f;d=c?"highlightFeaturesAndGoto":"highlightFeatures",e=u[b],e&&(e.type||e.featureGeometryType)&&(e=[e]),f=j.parseData(e),a.publish(d,[n,f])},_=function(){var c=a(".ol-overlay-container .popover-content footer button");b.each(c,function(b){var c=a(b),d=c.data("event");c.on("click",function(b){var c=a(".carousel .carousel-inner .item.active").data("id"),e=a(".popover-content h3").text();a.publish(d,[{urn:c,lonlat:m.getPosition(),objectType:e,geometry:u[c]}])})})},aa=function(a,b,c){if(void 0===b)return!1;var d,e,f=c.width()+8,g=c.height()+61,h=!1,i=j.getCurrentMapCentre(a),k=a.getPixelFromCoordinate(b),l=0,m=0;return k[0]<f/2?l=-(f/2-k[0]):k[0]>a.getSize()[0]-f/2&&(l=k[0]+f/2-a.getSize()[0]+4),k[1]<g&&(m=-(g-k[1])),(0!==l||0!==m)&&k[0]>0&&k[1]>0&&(h=!0,d=a.getCoordinateFromPixel([k[0]+l,k[1]+m]),e=[d[0]-a.getCoordinateFromPixel(k)[0],d[1]-a.getCoordinateFromPixel(k)[1]],a.getView().setCenter([i[0]+e[0],i[1]+e[1]])),h};x();var ba={createObjectPopup:D,createPopup:F,createMapClickPopup:G,createContentPopover:H,createSearchResultPopover:B,displayPopup:I,removePopup:J,setTemplate:z,updateLocationInformation:R,resetTemplatesToDefault:A,updatePopupAtPosition:E};return ba.__TEST_ONLY__={panMapIfOutOfView:aa,createPopup:F,createContentPopover:H,removePopup:J,createObjectPopup:D,createSearchResultPopover:B,createPopupSingleFeature:C,sortFeatureArrayByGeomType:U,updatePopupAtPosition:E,highlightItem:$,getFeatureCache:function(){return u},getPopUp:function(){return m},setPopOverTemplate:function(a){p=a},getTemplate:function(){return{popOverTemplate:p,popOverItemTemplate:q}},getPopUpContent:function(){return t},setNumberOfQueries:function(a){s=a},getNumberOfQueries:function(){return s},setCurrentLayerResponse:function(a){r=a},getCurrentLayerResponse:function(a){return r},getPopoversEnabled:function(){return w}},ba});