/*! ElectricOfficeWeb 5.0.1 2021-06-16 */
define(["jquery","underscore","OpenLayers3","proj4","map-loader","map-core-component/pubsub"],function(a,b,c,d,e){"use strict";function f(a,b){for(var c=a.getLength(),d=0;d<c;d++)if(b===a.item(d))return d;return-1}var g,h,i={},j="VuniverseZ0VworldZ0",k=new c.proj.get("EPSG:4326"),l={},m=function(){var a={name:e.MapOptions.MapProjectionName||"EPSG:3857",definition:e.MapOptions.MapProjectionDefinition||null,maxExtent:e.MapOptions.MaxExtent,maxResolution:e.MapOptions.MaxResolution};return a};g=m();var n=function(){a.subscribe("mapInitialised",function(a,b){i[a]=b}),a.subscribe("registerSpecialSelectionHandler",oa)},o=function(a){return!!a.features[0].geometry},p=function(a){if(a.length){for(var b=0;b<a.length-1&&void 0===a[b].type;)b++;return a[b]}return!1},q=function(){return e},r=function(a){return void 0!==a.features[0].geometry&&s(a.features[0].geometry)},s=function(a){var b;if(a){if(b=a.type||a.featureGeometryType,"Polygon"===b){var d=new c.geom.Polygon(a.coordinates);return d.getInteriorPoint().getCoordinates()}if("MultiPolygon"===b){var e=new c.geom.MultiPolygon(a.coordinates);return e.getInteriorPoints().getCoordinates()[0]}if("LineString"===b){if(a.coordinates.length%2===0){var f=a.coordinates[a.coordinates.length/2-1],g=a.coordinates[a.coordinates.length/2];return[(f[0]+g[0])/2,(f[1]+g[1])/2]}var h=a.coordinates[Math.floor(a.coordinates.length/2)];return[h[0],h[1]]}return"TEXT"===b?[a.geometry.coord.coordinates[0],a.geometry.coord.coordinates[1]]:[a.coordinates[0],a.coordinates[1]]}},t=function(a,b){v(a,b.getSource())},u=function(a,b){var d=new c.source.Vector({features:b});v(a,d)},v=function(a,b){if(b.getFeatures().length){var c=b.getExtent();L(a,c)}},w=function(a){var b=y(a),d=b.height>b.width?b.height:b.width,e=a;return e=c.extent.buffer(e,d/2)},x=function(a,b){if(!a||!b)throw new Error("Incorrect or empty layer or feature collection.");a.getSource().addFeatures(b)},y=function(a){var b=c.extent.getSize(a);return{width:b[0],height:b[1]}},z=function(){a(".map").addClass("busy")},A=function(){a(".map").removeClass("busy")},B=function(a){var d=[];return a&&a[0]?(b.each(a,function(a){var b;switch(a.type||a.featureGeometryType){case"Point":b=D(a);break;case"LineString":b=E(a);break;case"MultiPolygon":b=F(a);break;case"Polygon":b=G(a);break;case"TEXT":b=C(a);break;default:void 0!==a.type&&console.error(a.type+" not supported yet!",a)}b&&d.push(new c.Feature(b))}),d):d},C=function(a){return new c.geom.Point([a.geometry.coord.coordinates[0],a.geometry.coord.coordinates[1]])},D=function(a){return new c.geom.Point([a.coordinates[0],a.coordinates[1]])},E=function(a){return new c.geom.LineString(a.coordinates)},F=function(a){return new c.geom.MultiPolygon(a.coordinates)},G=function(a){return new c.geom.Polygon(a.coordinates)},H=function(a){var b;if(a){b=a.split("V");for(var c=0;c<b.length;c++)if(/collectionZ/.test(b[c]))return b[c].slice("collectionZ".length)}return null},I=function(a){return a.indexOf(j)!==-1},J=function(a,d){var e=b.extend({externalProjection:k,internalProjection:g.name},d),f=new c.format.GeoJSON({externalProjection:e.externalProjection,internalProjection:e.internalProjection});return f.writeFeatures(a)},K=function(a){return void 0===a&&(a=i.main_map),a.getSize()},L=function(a,b){a.getView().fit(b,K(a),{maxZoom:$(a)-1})},M=function(a){return void 0===a&&(a=i.main_map),a.getView().getCenter()},N=function(a,b){void 0===a&&(a=i.main_map),a.getView().setCenter(b)},O=function(a,b,c){N(a,b),aa(a,c)},P=function(a){return d("EPSG:4326",g.name,a)},Q=function(a){return d(g.name,"EPSG:4326",a)},R=function(a,b,c){var e=d(b,c,[a[0],a[1]]),f=d(b,c,[a[2],a[3]]);return[e[0],e[1],f[0],f[1]]},S=function(a,c,d){var e,f,g={},h=c||"V",i=d||"Z";return b.each(a.split(h),function(a,b){e=a.split(i)[0],f=a.split(i)[1],g[e]=f}),g},T=function(a){var b,c=!1;return a.isBaseLayer?c=a.isBaseLayer:(b=a.getSource(),b&&b.isBaseLayer&&(c=b.isBaseLayer)),c},U=function(){var a=[],b=i.main_map;return b?(b.getLayers().forEach(function(b){T(b)&&a.push(b)}),a):a},V=function(){var a=[],b=i.main_map;return b?(b.getLayers().forEach(function(b){T(b)||a.push(b)}),a):a},W=function(a){var b,c=a.getSource();if(c){if(b=c.name,!b)try{b=c.getLayer()}catch(d){b=void 0}}else b=a.name;return b},X=function(a){var b,c=a.getSource();return b=c?c.type?c.type:c.getLayer():a.type},Y=function(a){var b;return a&&(b=a.visible?a.visible:a.getVisible()),b},Z=function(a){var b;return b=a.get("InternalLayerName")||W(a),b&&(b=b.trim().split(" ").join("-")),b},$=function(a){void 0===a&&(a=i.main_map);var b=a.getView().getProperties().maxZoom;return b},_=function(a){return void 0===a&&(a=i.main_map),a.getView().getZoom()},aa=function(a,b){a.getView().setZoom(b)},ba=function(a){void 0===a&&(a=i.main_map);var b=a.getView();return b.getProjection().getMetersPerUnit()*ca()},ca=function(a){return void 0===a&&(a=i.main_map),a.getView().getResolution()},da=function(a){var b=i.main_map;return b.getPixelFromCoordinate(a)},ea=function(a){for(var b=[],c=0;c<a.length;c++)b.push(da(a[c]));return b},fa=function(a){var b=i.main_map;return b.getCoordinateFromPixel(a)},ga=function(a){for(var b=[],c=0;c<a.length;c++)b.push(fa(a[c]));return b},ha=function(a){return a.getView().calculateExtent(a.getSize())},ia=function(a){var b,c=i.main_map;if(c)return c.getLayers().forEach(function(c){c.get("name")===a&&(b=c)}),b},ja=function(a){var b=[],c=i.main_map;return c&&c.getOverlays().forEach(function(c){c.get("name")===a&&b.push(c)}),b},ka=function(a,b){var c=[],d=i.main_map;return d?(d.getLayers().forEach(function(d){Boolean(d.get(a))===b&&c.push(d)}),c):c},la=function(a,b,c){var d,e=!1,f=i.main_map,g=0,h=0,j=!1,k=function(a){e=!0,b(a)},l=a,m=l,n=0;if(f)for(c||(c=5),f.forEachLayerAtPixel(l,k);!e&&!j;)0===n&&(n=Math.atan2(2,c)),g>=2*Math.PI&&(g=0),0===g&&h++,h>=c&&(j=!0),m=[],d=h*Math.cos(g),m[0]=Math.round(l[0]+d),d=h*Math.sin(g),m[1]=Math.round(l[1]+d),g+=n,l!==m&&(l=m,f.forEachLayerAtPixel(m,k))},ma=function(){var a=i.main_map;if(a)return a.getLayers().getArray()},na=function(a,b){var c=b.centerLonLat[0],d=b.centerLonLat[1],e=a[0],f=a[1],g=a[2],h=a[3];return e<=c&&c<=g&&f<=d&&d<=h},oa=function(a,b){l[a]=b},pa=function(a){h=a},qa=function(){return h},ra=function(a,b){a.unByKey(b)},sa=function(a,b,c){var d=f(a.getLayers(),b);d!==c&&(a.getLayers().removeAt(d),a.getLayers().insertAt(c,b))},ta=function(a,c,d){a.forEachFeatureAtPixel(c.pixel,l[W(d)]||function(a){},null,function(c){if(a.getLayers().getArray().indexOf(c)!==-1){var d=W(c);return d&&b.contains(Object.keys(l),d)}})},ua=function(c,f,h){var i=[],j=!1,k=c.getTarget();h||(h=0),b.each(e.Layers.Google,function(a){"Google Traffic"===a.ExternalLayerName?(j=!0,a.Visible&&(trafficLayerVisible=!0)):"roadmap"===a.Type?i.push(google.maps.MapTypeId.ROADMAP):"satellite"===a.Type?i.push(google.maps.MapTypeId.SATELLITE):"hybrid"===a.Type?i.push(google.maps.MapTypeId.HYBRID):"terrain"===a.Type&&i.push(google.maps.MapTypeId.TERRAIN)});var l=document.createElement("div"),m=k.parentNode;l.id=f,l.style.height="100%",l.style.width="100%",m.insertBefore(l,m.firstChild);var n,o=new google.maps.Map(a("#"+f)[0],{disableDefaultUI:!0,keyboardShortcuts:!1,draggable:!1,disableDoubleClickZoom:!1,scrollwheel:!1,streetViewControl:!1,mapTypeControl:!0,tilt:0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,mapTypeIds:i,position:google.maps.ControlPosition.LEFT_BOTTOM}}),p=c.getView();return p.on("change:center",function(){n=d(g.name,"EPSG:4326",p.getCenter()),o.setCenter(new google.maps.LatLng(n[1],n[0]))}),p.on("change:resolution",function(){o.setZoom(p.getZoom()-h)}),google.maps.event.addListenerOnce(o,"idle",function(){n=d(g.name,"EPSG:4326",p.getCenter()),o.setCenter(new google.maps.LatLng(n[1],n[0])),o.setZoom(p.getZoom()-h)}),k.style.position="absolute",k.style.top="0px",k.style.left="0px",a(window).resize(function(){var a=o.getCenter();window.google.maps.event.trigger(o,"resize"),o.setCenter(a)}),!0},va=function(a,b,d,e){var f=new c.source.Vector({}),g=new c.layer.Vector({source:f,extent:b.maxExtent,maxResolution:b.maxResolution,renderOrder:null,visible:!0,name:d,style:e});f.name=d,a.addLayer(g)},wa=function(a){if(!e.authGroupList){var c={};b.each(e.layerAuth,function(a,d){b.each(a.layers,function(b){c[b]||(c[b]=[]),c[b].push({scope:d,name:a.name})})}),e.authGroupList=c}return e.authGroupList[a]},xa=function(a){if(!e.wmtsExternalToInternalLayerNameMap){var c={};e.Layers&&e.Layers.WMTS&&b.each(e.Layers.WMTS,function(a){c[a.ExternalLayerName]=a.InternalLayerName}),e.wmtsExternalToInternalLayerNameMap=c}return e.wmtsExternalToInternalLayerNameMap[a]};n();var ya={addVectorLayer:va,clearBusyCursor:A,dataCentralGeometry:p,featureContainsGeometry:o,findCentrePointOfFeatures:r,findCentrePointOfGeometry:s,getCollectionName:H,getCurrentMapCentre:M,setCurrentMapCentre:N,setCurrentMapCentreAndZoom:O,getFormattedFeatures:J,gotoExtentsOfLayer:t,gotoExtentsOfFeatures:u,isGeographicWorld:I,parseData:B,setBusyCursor:z,transformToMapProjection:P,transformToLonLat:Q,getMapProjection:m,getObjectFromUrn:S,isBaseLayer:T,getBaseLayers:U,getNonBaseLayers:V,getLayerId:Z,getVisibility:Y,getLayerName:W,getLayerType:X,getNumberOfMetersPerPixel:ba,getPixelFromCoordinate:da,getPixelsFromCoordinateList:ea,getCoordinateFromPixel:fa,getCoordinatesFromPixelList:ga,fitMapToBounds:L,getNumberOfZoomLevels:$,getCurrentZoomLevel:_,setCurrentZoomLevel:aa,getMapSize:K,getMapBounds:ha,getMapResolution:ca,getLayerByName:ia,getMapLayers:ma,getMapConfig:q,forEachLayerAtPixel:la,transformExtent:R,addFeaturesToLayer:x,containsFeature:na,getBoundsSizes:y,doubleBounds:w,getLayersBy:ka,getOverlaysByName:ja,handleSpecialSelection:ta,setContinueSelecting:pa,getContinueSelecting:qa,unByKey:ra,setLayerIndex:sa,createGoogleLayerForMap:ua,authGroups:wa,wmtsLayerInternalNameForExternalName:xa};return ya.__TEST_ONLY__={eventSubscribe:n,isGeographicWorld:I,overRideGetBoundsSizes:function(){y=function(){return{width:100,height:100}}},resetRideGetBoundsSizes:function(){y=function(a){var b=a.getSize();return{width:b.w,height:b.h}}},setMainMap:function(a){i.main_map=a}},ya});