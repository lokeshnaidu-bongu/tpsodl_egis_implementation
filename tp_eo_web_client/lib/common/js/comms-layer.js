/*! ElectricOfficeWeb 5.0.1 2021-06-16 */
define(["jquery","server-config","i18n!viewer/nls/messages"],function(a,b,c){"use strict";var d=function(){return window.localStorage.getItem("gss_access_token")},e=function(){var a=window.localStorage.getItem("gss_is_unauthenticated");return a&&"true"===a.toString()},f=function(a){window.localStorage.setItem("gss_is_unauthenticated",a)},g=function(b){if(!e()){var c=d();return c&&a.extend(!0,b,{headers:{Authorization:"Bearer "+c}}),b}},h=function(b,d,e,f){if(401===d.status)a.publish("raiseStickyMessage",[c.commsLayer.unauthenticated,{messageType:"error"}]);else if(403===d.status)a.publish("raiseStickyMessage",[c.commsLayer.unauthorized,{messageType:"error"}]);else if(d.status>=400&&d.status<500){var g=d.response?d.response:d.status;a.publish("raiseTempMessage",[c.commsLayer.serverError.replace("$1",g||""),{messageType:"warning"}])}else a.publish("raiseTempMessage",[c.commsLayer.serverError.replace("$1",d.statusText||""),{messageType:"warning"}]);b&&b(d,e,f)},i=function(b,c,d){b=a.extend(!0,{},b);var e={cache:!1,dataType:"json",url:b.url,data:b,success:function(a,b,d){c(a,b,d)},error:function(a,b,c){h(d,a,b,c)}};g(e),a.ajax(e)},j=function(c,d,e,f){c=a.extend(!0,{json:!0},c);var i={dataType:"json",url:b.GSSServer||"/gss",data:c,success:function(a,b,c){d(a,b,c)},error:function(a,b,c){h(e,a,b,c)}};a.extend(!0,i,f||{}),g(i),a.ajax(i)},k=function(c,d,e,f){c=a.extend(!0,{},c);var i={dataType:"json",contentType:"application/x-www-form-urlencoded; charset=UTF-8",url:(b.GSSServer||"/gss")+d,type:"post",data:c,success:function(a,b,c){e(a,b,c)},error:function(a,b,c){h(f,a,b,c)}};g(i),a.ajax(i)},l=function(c,d,e){c=c?c:b.GSSServer||"/gss";var f={dataType:"text",url:c,success:function(a,b,c){d(a,b,c)},error:function(a,b,c){h(e,a,b,c)}};g(f),a.ajax(f)},m=function(b){b.status&&200!==b.status&&(401===b.status?a.publish("raiseStickyMessage",[c.commsLayer.tileAccessUnauthenticated,{messageType:"error"}]):403===b.status?a.publish("raiseStickyMessage",[c.commsLayer.tileAccessUnauthorized,{messageType:"error"}]):a.publish("raiseTempMessage",[c.commsLayer.tileAccessServerError.replace("$1",b.statusText||""),{messageType:"warning"}]))},n=function(a,b){var c=new XMLHttpRequest;c.open("GET",b);var f=d();f&&!e()&&c.setRequestHeader("Authorization","Bearer "+f),c.responseType="arraybuffer",c.onload=function(){m(c);var b=new Uint8Array(this.response),d=new Blob([b],{type:"image/png"}),e=window.URL||window.webkitURL,f=e.createObjectURL(d);a.getImage().src=f},c.send()},o={getNodeRequest:i,getGSSRequest:j,getGSSDocument:l,postGSSRequest:k,getBearerToken:d,MaybeAddBearerToken:g,customLoader:n,isUnauthenticatedApp:e,setStatusOfUnauthentication:f};return o.__TEST_ONLY__={handleCommsError:h,reportMapTileAccessError:m},o});