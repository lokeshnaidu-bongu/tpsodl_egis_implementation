/*! ElectricOfficeWeb 5.0.1 2021-06-16 */
define(["jquery","underscore","OpenLayers3","results-list","map-helper","i18n!viewer/nls/messages","map-loader","text!internals-partials/internals.html","hogan","comms","popovers","map","map-core-component/pubsub","spinner"],function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";var m=i.compile(h),n="internals",o="internals",p="EPSG:3857",q=g.internalsMaxExtent||[-2147483647,-2147483647,2147483647,2147483647],r={strokeWidth:5,strokeColor:"rgba(255, 153, 0, 0.75)"};g.style&&(r=b.extend(r,g.style.tracing));var s,t,u,v,w,x,y,z,A,B,C=new c.style.Stroke({color:r.strokeColor,width:r.strokeWidth}),D=new c.style.Circle({radius:10,fill:new c.style.Fill({color:[0,0,0,1]}),stroke:C}),E=new c.style.Style({stroke:C,image:D}),F={},G=!1,H=function(){a.subscribe("showObjectDetails",function(b){L(),M(b.urn,!1),G||(a("#largeIntButton").on("click",function(){Z(b)}),G=!0)}),a.subscribe("objectDetailsBoxReady",function(a,b){a===n&&I(b)}),a.subscribe("setTraceResult",function(a){z=a,A&&Y(A)}),a.subscribe("clearTraceResult",function(){y&&(z=void 0,w&&(w.removeLayer(y),y=void 0))}),a.subscribe("overlayInitialised",function(a,b){b&&y&&b.addLayer(y)})},I=function(a){s=a,K(),V(t)},J=function(){var a=new c.source.Vector({layer:"Trace Layer",wrapX:!1});y=new c.layer.Vector({style:E,source:a,extent:q,renderOrder:null,visible:!0,name:"Trace layer",zIndex:1e3})},K=function(){var b={messages:f};s.html(m.render(b)),s.show(),t=a("#internalsMap.map",s),u=a("#results-list",s)},L=function(){v&&v.clear(),s&&s.hide(),a.publish("clearHighlight",[o])},M=function(b,c){0===a("#internalLoadingSpinner").length&&(a("#internals-details-box .module-header").append('<span id="internalLoadingSpinner" rel="spinner"style="right:25px; top:25px; position:absolute"></span>'),a("#internalLoadingSpinner").spin()),B=b;var d={service:"ejb/WorldInfoLocal",method:"internalRwos",urn:b,json:!0,result_type:"all",crs:p,ace_visibility_tag:g.tags.internals||"web_export",internal_world_filter_alias:g.internalWorldFilterAlias||"standard"};if(c){if(w){var e=w.getView().calculateExtent(w.getSize()),f=w.getView().getResolution().toFixed(0);d.bounds=""+e[0]+","+e[1]+","+e[2]+","+e[3],d.view_scale=f,j.getGSSRequest(d,S,T)}}else j.getGSSRequest(d,O,T)},N=function(a){var b=new c.interaction.MouseWheelZoom;a.addInteraction(b)},O=function(b){var c,d=Object.keys(b.contexts||{});b.world_description?(Q=!1,A=b,c=W(g.Layers.AdditionalWorlds||[],b.world_description,d.length?d[0]:""),s.show(),U(x,c,b.geoms_bounds),y&&y.getSource().clear(),x=c,w.render(),Y(A),v.renderResults(b.features.features,{contexts:b.contexts,keepCurrentFilter:!1}),Q=!0):L(),a("#internalLoadingSpinner").remove()},P=function(){var a;b.find(w.getLayers().getArray(),function(b){var d=b.getSource();if(d&&d instanceof c.source.WMTS&&(a=d.getMatrixSet()))return!0});return a},Q=!0,R=function(a){B&&Q&&M(B,!0)},S=function(b){v.renderResults(b.features.features,{contexts:b.contexts,keepCurrentFilter:!0}),w.updateSize(),a("#internalLoadingSpinner").remove()},T=function(a,b,c){L(),console.log(a,b,c)},U=function(a,b,c){if(w.updateSize(),a&&w.removeLayer(a),b&&w.addLayer(b),c){var d=e.doubleBounds(c);w.getView().extent=d,e.fitMapToBounds(w,d)}},V=function(b){var e={theme:null,projection:p,units:"m",numberOfZoomLevels:100,maxExtent:q,center:[0,0],interactions:c.interaction.defaults({altShiftDragRotate:!1,dragPan:!1,pinchRotate:!1}).extend([new c.interaction.DragPan({kinetic:new c.Kinetic((-.03),.05,100)})])};return!w&&(o="internals",w=l.getNewMap(b,e),window.internalMap=w,v=d.getNewResultsList({useGeographic:!1,selector:u,paging:!0,map:{olMap:w,mapName:o},parentComponent:n,"export":!1,filter:!0}),N(w),w.getView().on("change:center",function(){X(w)}),w.on("moveend",function(a){R(a)}),a.publish("internalsMapInitialised",[o,w]),!0)},W=function(a,b,c){var d={worldDescription:b,additionalWorldsConfig:a,contextName:c,maxExtent:q,projection:p,olMapRef:w,dimensions:{cache_in_database:!1}};return F.worldDescription=b,F.additionalWorldsConfig=a,F.contextName=c,l.getNewMapLayer(d)},X=function(a){var b=a.getView().extent,d=e.getCurrentMapCentre(a);void 0!==b&&(c.extent.containsCoordinate(b,d)||(d[0]<=b[0]&&(d[0]=b[0]),d[1]<=b[1]&&(d[1]=b[1]),d[0]>=b[2]&&(d[0]=b[2]),d[1]>=b[3]&&(d[1]=b[3]),e.setCurrentMapCentre(a,d)))},Y=function(a){w&&z&&(J(),w.addLayer(y),b.each(z.visited_geoms,function(c,d){if(d===a.world_urn)return void b.each(c,function(a){var b=e.parseData([{coordinates:a.coordinates,type:"LineString"}]);y.getSource().addFeatures(b)})}))},Z=function(b){$(b),b.content=l.createMap(b),a.publish("triggerOverlay",[b])},$=function(a){a.theme=w.theme,a.projection=w.getView().getProjection().getCode(),a.units=w.getView().getProjection().getUnits(),a.numberOfZoomLevels=100,a.defaultZoom=w.getView().getZoom(),a.center=w.getView().getCenter(),a.maxExtent=q,a.urn=B,a.worldDescription=F.worldDescription,a.additionalWorldsConfig=F.additionalWorldsConfig,a.contextName=F.contextName};H();var _={initialise:I,getWorldDescription:P};return _.__TEST_ONLY__={initTraceLayer:J,showLargeInternals:Z,startInternalsMap:V,setOlMap:function(a){w=a},setTraceLayer:function(a){y=a},getTraceLayer:function(){return y},getCardSelector:function(){return s},setInternalsTemplate:function(a){m=a},setDetailsResult:function(a){A=a},getInternalsDataCallback:O,setResultsList:function(a){v=a},setCardSelector:function(a){s=a},setMapSelector:function(a){t=a},setInternalLayer:function(a){x=a},getNewInternalsLayer:W,errorCallback:T,stubUpdateMapParams:function(a){$=a}},_});