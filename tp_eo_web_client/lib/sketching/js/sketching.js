/*! ElectricOfficeWeb 5.0.1 2021-06-16 */
define(["jquery","underscore","window-manager","OpenLayers3","sketching-component/measure","sketching-component/arrow","sketching-component/text","sketching-component/lines","sketching-component/areas","i18n!viewer/nls/messages","map-loader","map-helper","text!sketching-partials/sketch.html","hogan","popovers","comms","sketching-component/symbols","sketching-component/task","text!viewer-icons/icon-tip.svg","map-core-component/pubsub"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){"use strict";var t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N=n.compile(m),O="sketching",P=n.compile('<div class="btn-group btn-filter delete-feature" style="padding-right:10px;"><button class="btn btn-map">{{messages.sketching.deleteSketchButton}}</button></div>'),Q=a(".map-toolbar .pull-right"),R=new d.style.Fill({color:[255,105,180,.5]}),S=new d.style.Circle({radius:7,fill:R}),T=new d.style.Stroke({color:[0,128,255,.3],width:4}),U=new d.style.Style({fill:R,image:S,stroke:T}),V={},W=!1,X=l.getMapProjection(),Y=new d.Collection,Z=[],$=15,_=function(){a.subscribe("sidebarContainerReady",function(a,b){a===O&&oa(b,{id:a})}),a.subscribe("leavingSidebar",function(b){b===O&&(a.publish("enablePopovers"),Wa(),K&&e.hideDimension(),ta(),Oa(),J&&J.setActive(!1),ca(w)),da(!0),I&&(l.unByKey(w,I),I=void 0)}),a.subscribe("gotoSidebar",function(b){b===O&&(La(w),wa(),ka(),a.publish("registerListenersToMapCreated",[]),a.publish("clearPopovers",[!0]),a.publish("disablePopovers"))}),a.subscribe("deactivateSketching",function(){Ya()}),a.subscribe("activateSketching",function(){Xa()}),a.subscribe("mapInitialised",function(a,b){w=b,D=a,e.setMap(w)}),a.subscribe("buttonPaletteCreated",function(a){ja(a)}),a.subscribe("registerListenersToMapCreated",function(){ma(w)}),a.subscribe("editingTextFeature",function(a){Na(a)}),a.subscribe("finishedEditingTextFeature",function(a){Oa(),Wa(),E.setActive(!0),F.setActive(!0)}),a.subscribe("finishedCreatingTextFeature",function(a){Wa(),E.setActive(!0),F.setActive(!0),a&&ba(a)})},aa=function(){c.isTouchDevice()&&($=w.getView().getResolution()*k.touchPixelHitRadius)},ba=function(a){E.getFeatures().clear(),E.getFeatures().push(a),Na(a)},ca=function(a){b.each(a.getInteractions().getArray(),function(b){b instanceof d.interaction.Draw?a.removeInteraction(b):b instanceof d.interaction.DoubleClickZoom&&b.setActive(!1)}),I&&(l.unByKey(w,I),I=void 0)},da=function(a){b.each(w.getInteractions().getArray(),function(b){b instanceof d.interaction.DoubleClickZoom&&b.setActive(a)})},ea=function(){b.each(V.lines,function(b,c){a("#"+c).click(function(){ca(w),E.setActive(!1),F.setActive(!1),G.setActive(!1),Ka(w,w.getView(),b),b.on("drawstart",function(a){a.feature.getGeometry().on("change",function(){e.showDimension(a.feature.getGeometry())})}),b.on("drawend",function(a){a.feature.setStyle(b.getProperties().customStyle),w.removeInteraction(b),Wa(),E.setActive(!0),F.setActive(!0),G.setActive(!0),ra(a.feature,U),e.showDimension(a.feature.getGeometry()),t.getSource().once("addfeature",function(a){ba(a.feature)})})})})},fa=function(){b.each(V.arrows,function(b,c){a("#"+c).click(function(){ca(w),E.setActive(!1),F.setActive(!1),G.setActive(!1),Ka(w,w.getView(),b),b.on("drawstart",function(a){a.feature.getGeometry().on("change",function(){e.showDimension(a.feature.getGeometry())})}),b.on("drawend",function(a){var c,g=a.feature.getGeometry(),h=g.getLastCoordinate();g.forEachSegment(function(a,b){if(b[0]===h[0]&&b[1]===h[1]){var e,i,j=b[0]-a[0],k=b[1]-a[1],l=Math.atan2(k,j),m=[];e=f.drawArrowTip(b,l,10),m.push(g),m.push(e[0]),m.push(e[1]),i=new d.geom.GeometryCollection(m),c=new d.Feature({geometry:g})}}),c.setStyle(b.getProperties().customStyle),c.setProperties({parserStyle:b.getProperties().parserStyle}),t.getSource().addFeature(c),ba(c),w.removeInteraction(b),Wa(),E.setActive(!0),F.setActive(!0),G.setActive(!0),qa(c,U),e.showDimension(a.feature.getGeometry()),t.getSource().once("addfeature",function(a){t.getSource().removeFeature(a.feature)})})})})},ga=function(){b.each(V.areas,function(b,c){a("#"+c).click(function(){ca(w),E.setActive(!1),F.setActive(!1),G.setActive(!1),Ka(w,w.getView(),b),b.on("drawstart",function(a){a.feature.getGeometry().on("change",function(){e.showDimension(a.feature.getGeometry())})}),b.on("drawend",function(a){a.feature.setStyle(b.getProperties().customStyle),w.removeInteraction(b),Wa(),E.setActive(!0),F.setActive(!0),G.setActive(!0),sa(a.feature,U),t.getSource().once("addfeature",function(a){ba(a.feature)})})})})},ha=function(a,b,c){var d={color:a,colorName:b,map:w,sketchLayer:t};l.unByKey(w,I),g.startTextCapture.bind(g,c,d)()},ia=function(){b.each(V.texts,function(b,c){a("#"+c).click(function(){ca(w),E.setActive(!1),F.setActive(!1),a.publish("terminateDrawingOperation"),I=w.on("click",ha.bind(this,b.color,b.colorName))})})},ja=function(c){v&&(c&&(y=c,na(y)),b.extend(V,{lines:h.addControls(k.sketching.colours,k.sketching.line_strokes,v,t,Y)},{arrows:f.addControls(k.sketching.colours,v,t,Y)},{areas:i.addControls(k.sketching.colours,k.sketching.area_strokes,v,t,Y)},{texts:g.addControls(k.sketching.colours,v)}),ea(),fa(),ga(),ia(),a.publish("registerListenersToMapCreated",[]))},ka=function(){r.isTaskManagerConnected()?a("#symbolButtons .sketchButton").length<1&&q.init():(ja(),Sa()),E&&(E.setActive(!0),F.setActive(!0),G.setActive(!0)),da(!0)},la=function(a){var b,c=[],e=new d.style.Fill({color:[50,50,250,.75]}),f=new d.style.Stroke({color:[200,200,200,.75],width:4});return b=a?new d.style.Icon({scale:1.5,size:[a.width,a.height],imgSize:[a.width,a.height],src:a.svg}):new d.style.Circle({radius:7,fill:e}),c.push(new d.style.Style({fill:e,stroke:f,image:b})),c},ma=function(b){var c=!a.isEmptyObject(V);!W&&b&&c&&(Ra(),W=!0)},na=function(c){b.each(c,function(b,c){a("#point_symbol_"+c+"_red").click(function(){var a,e;ca(w),a=la(q.getImageSvg(b)),e=new d.interaction.Draw({source:t.getSource(),features:Y,style:a,type:"Point"}),E.setActive(!1),F.setActive(!1),G.setActive(!1),Ka(w,w.getView(),e),e.on("drawend",function(b){b.feature.setProperties({symbolName:c}),b.feature.setStyle(a),w.removeInteraction(e),Wa(),E.setActive(!0),F.setActive(!0),G.setActive(!0),t.getSource().once("addfeature",function(a){ba(a.feature)})})}),V["point_symbol_"+c+"_red"]=c})},oa=function(b){v=b,v.html(N.render({messages:j,TipSvg:s})),a.publish("sidebarReady",[]),r.initialise(a("select#taskManagementTaskType"),a("select#taskManagementTaskRecipient"))},pa=function(a,b){var c=a.getGeometry().getExtent(),e=d.extent.getCenter(c);M&&(t.getSource().removeFeature(M),M=void 0),a.centrePx=l.getPixelFromCoordinate(e),a.angle=0,M=new d.Feature({geometry:new d.geom.Point([e[0]+d.extent.getWidth(c)/1.5,e[1]]),isRotationAnchor:!0}),M.setStyle(b),t.getSource().addFeature(M)},qa=function(a,c){var e,f;ta(),"LineString"===a.getGeometry().getType()?(e=a.getGeometry().getCoordinates(),f=d.extent.getCenter(a.getGeometry().getExtent())):(e=a.getGeometry().getGeometries()[0].getCoordinates(),f=d.extent.getCenter(a.getGeometry().getGeometries()[0].getExtent())),K=a,b.each(e,function(a){var b=new d.Feature({geometry:new d.geom.Point(a)});b.setStyle(c),t.getSource().addFeature(b),Z.push(b)}),L=new d.Feature({geometry:new d.geom.Point(f),isMiddleAnchor:!0,feature:a}),L.setStyle(c),t.getSource().addFeature(L),Z.push(L),pa(a,c)},ra=function(a,c){var f;ta(),K=a,b.each(a.getGeometry().getCoordinates(),function(a){var b=new d.Feature({geometry:new d.geom.Point(a)});b.setStyle(c),t.getSource().addFeature(b),Z.push(b)}),f=d.extent.getCenter(a.getGeometry().getExtent()),L=new d.Feature({geometry:new d.geom.Point(f),isMiddleAnchor:!0,feature:a}),L.setStyle(c),t.getSource().addFeature(L),Z.push(L),pa(a,c),e.showDimension(a.getGeometry())},sa=function(a,c){ta(),K=a,b.each(a.getGeometry().getCoordinates()[0],function(a){var b=new d.Feature({geometry:new d.geom.Point(a)});b.setStyle(c),t.getSource().addFeature(b),Z.push(b)}),pa(a,c),e.showDimension(a.getGeometry())},ta=function(){Z.length>0&&(b.each(Z,function(a){t.getSource().removeFeature(a)}),Z=[]),M&&(t.getSource().removeFeature(M),M=void 0)},ua=function(a){E.on("select",function(b){if(ta(),b.selected[0]){var c=b.selected[0],d=c.getGeometry().getType();K=c,"GeometryCollection"===d?qa(c,a):"LineString"===d?ra(c,a):"Polygon"===d?sa(c,a):c.getProperties().isTextLabel&&g.startTextEdit.bind(g,c,w)(),c.getProperties().isMiddleAnchor||Na(c)}else K=null,Oa(),e.hideDimension()})},va=function(a){F.on("translatestart",function(a){ta()}),F.on("translateend",function(c){var e=c.features.getArray()[0];b.each(e.getGeometry().getCoordinates()[0],function(b){var c=new d.Feature({geometry:new d.geom.Point(b)});c.setStyle(a),t.getSource().addFeature(c),Z.push(c)}),E.setActive(!0),pa(e,a)})},wa=function(){var a=new d.style.Fill({color:[255,105,180,.5]}),b=new d.style.Circle({radius:7,fill:a}),c=new d.style.Style({fill:a,image:b});E||(E=new d.interaction.Select({layers:[t],style:c,id:"SkechingSelectControl"}),F=new d.interaction.Translate({layers:[t],features:E.getFeatures(),style:c,id:"SkechingTranslateControl"}),G=new d.interaction.Modify({features:E.getFeatures(),style:U,id:"SkechingModifyControl"}),G.on("modifyend",xa(U)),J=new d.interaction.Pointer({handleDownEvent:Ea(),handleDragEvent:Fa(),handleUpEvent:Ga(U),id:"SkechingClickDetectionControl"}),H=new d.interaction.Pointer({handleDownEvent:ya(),handleDragEvent:Ba(),handleUpEvent:Da(U),id:"SkechingRotateControl"})),E.setActive(!0),G.setActive(!0),F.setActive(!0),H.setActive(!0),J.setActive(!0),Ka(w,w.getView(),E),Ka(w,w.getView(),F),Ka(w,w.getView(),G),Ka(w,w.getView(),H),Ka(w,w.getView(),J),ua(U),va(U),da(!0)},xa=function(a){return function(c){if(c){var d,e=c.features.getArray()[0];e&&(Z.length>0&&(b.each(Z,function(a){t.getSource().removeFeature(a)}),Z=[]),K=e,d=e.getGeometry().getType(),"GeometryCollection"===d?qa(K,a):"LineString"===d?ra(K,a):"Polygon"===d&&sa(K,a))}}},ya=function(){return function(a){var b,c,d,e;if(a.coordinate&&M)return b=l.getPixelFromCoordinate(a.coordinate),c=l.getPixelFromCoordinate(M.getGeometry().getCoordinates()),d=c[0]-b[0],e=c[1]-b[1],Math.pow(d,2)+Math.pow(e,2)<=Math.pow($,2)&&(E.setActive(!1),F.setActive(!1),K.geometry=K.getGeometry(),K.angle=Ca(K,a.coordinate),!0)}},za=function(a,b,c){return function(a,d,e){for(var f,g,h,i,j=Math.cos(c),k=Math.sin(c),m=0;m<a.length;m+=e)f=l.getPixelFromCoordinate([a[m],a[m+1]]),g=f[0]-b[0],h=b[1]-f[1],i=l.getCoordinateFromPixel([b[0]+(g*j-h*k),b[1]-(g*k+h*j)]),d[m]=i[0],d[m+1]=i[1];return d}},Aa=function(a,b,c){b.geometry.applyTransform(za(a,b.centrePx,c))},Ba=function(){var a;return function(c){Z.length>0&&(b.each(Z,function(a){t.getSource().removeFeature(a)}),Z=[]),a=Ca(K,c.coordinate),Aa(w,K,a),K.angle+=a,M.getGeometry().setCoordinates(c.coordinate)}},Ca=function(a,b){var c=l.getPixelFromCoordinate(b),d=a.centrePx,e=c[0]-d[0],f=d[1]-c[1],g=Math.atan2(f,e)-a.angle;return g},Da=function(a){return function(b){var c=K.getGeometry().getType();return"GeometryCollection"===c?qa(K,a):"LineString"===c?ra(K,a):"Polygon"===c&&sa(K,a),E.setActive(!0),F.setActive(!0),!1}},Ea=function(){return function(a){var b,c,d,e,f;if(L&&(b=l.getPixelFromCoordinate(a.coordinate),c=l.getPixelFromCoordinate(L.getGeometry().getCoordinates()),d=c[0]-b[0],e=c[1]-b[1],Math.pow(d,2)+Math.pow(e,2)<=Math.pow($,2))){var g=L.clone();return E.setActive(!1),F.setActive(!1),G.setActive(!1),t.getSource().addFeature(g),Z.push(g),K.geometry=K.getGeometry(),!0}return f=w.forEachFeatureAtPixel(a.pixel,function(a,b){if(a.getProperties().isTextLabel)return a}),!!f&&(this.dragCoordinate=a.coordinate,this.draggedFeature=f,!0)}},Fa=function(){var a;return function(b){return this.draggedFeature?void this.draggedFeature.getGeometry().setCoordinates(b.coordinate):(ta(),L.centrePx=l.getPixelFromCoordinate(L.getGeometry().getCoordinates()),a=Ha(L,b.coordinate),Ia(w,K,a),void L.getGeometry().setCoordinates(b.coordinate))}},Ga=function(a){return function(b){if(K){var c=K.getGeometry().getType();"GeometryCollection"===c?qa(K,a):"LineString"===c?ra(K,a):"Polygon"===c&&sa(K,a)}return E.setActive(!0),F.setActive(!0),G.setActive(!0),this.draggedFeature=null,this.dragCoordinate=null,!1}},Ha=function(a,b){var c=l.getPixelFromCoordinate(b),d=a.centrePx,e=c[0]-d[0],f=d[1]-c[1];return[e,f]},Ia=function(a,b,c){b.geometry.applyTransform(Ja(a,b.centrePx,c))},Ja=function(a,b,c){return function(a,b,d){for(var e,f,g=0;g<a.length;g+=d)e=l.getPixelFromCoordinate([a[g],a[g+1]]),f=l.getCoordinateFromPixel([e[0]+c[0],e[1]-c[1]]),b[g]=f[0],b[g+1]=f[1];return b}},Ka=function(a,b,c){c&&(b.interactions||(b.interactions=[]),b.interactions.push(c),a.addInteraction(c))},La=function(a){if(!t){var b=new d.source.Vector({});t=new d.layer.Vector({source:b,extent:X.maxExtent,maxResolution:X.maxResolution,renderOrder:null,visible:!0,name:"Sketching Layer",style:la()}),a.addLayer(t),aa()}},Ma=function(b,c){Q.length||(Q=a(".map-toolbar .trace-actions")),c?Q.append(b):Q.prepend(b)},Na=function(b){var c;u&&Oa(),c=P.render({messages:j}),Ma(c,!1),u=a(".delete-feature",Q),a("button",u).off("click touchend").on("click touchend",function(){Pa(b),o.removePopup()})},Oa=function(){u&&u.remove()},Pa=function(b){a.publish("willDeleteFeature",b),b&&(b.set("SYS!DELETED",!0),E.getFeatures().clear(),ta(),t.getSource().removeFeature(b),e.hideDimension(),Oa(),g.closePopover(),eb(!0))},Qa=function(b){var c=a("#"+b,v),d=a(".controlOptions .sketchControlOptions",v);d.hide(),c.show(),c.css("display","block")},Ra=function(){c.isTouchDevice()?(a("#sketchControl .sketchButton .btn:not(.controlOptions .btn)",v).on("touchend",Ta),a("#sketchControl .controlOptions .btn",v).on("click touch",Ta),a("#sketchFinalise #cancel",v).on("touchend",Ua),a("#sketchFinalise #submit",v).on("touchend",Va)):(a("#sketchControl .sketchButton .btn").on("click",Ta),a("#sketchFinalise #cancel",v).on("click",Ua),a("#sketchFinalise #submit",v).on("click",Va))},Sa=function(){a("#point_control").hide(),a("#sketchFinalise #submit",v).hide(),a("#sketchingDetails").hide()},Ta=function(){var c,e=a(this),f=e[0].id,g="",h=!1,i=!1;e.hasClass("active")?(((c=e.data("options"))||C===e)&&(h=!0),Wa(h),b.each(w.getInteractions().getArray(),function(a){a instanceof d.interaction.Draw?w.removeInteraction(a):a instanceof d.interaction.DoubleClickZoom&&a.setActive(!0)}),I&&l.unByKey(w,I),E.setActive(!0),G.setActive(!0),F.setActive(!0),a.publish("terminateDrawingOperation")):""!==f&&((c=e.data("options"))?(Qa(c),i=!0,h=!0,Wa(h),C=e):((c=e.data("options-group"))?Qa(c):(Qa("noOptions"),h=!0),g=e.data("descrip"),Wa(h),B=e),cb(f),e.addClass("active"),db(g),i&&a("#"+c+" button:first",v).click())},Ua=function(){z&&Wa(),Za()},Va=function(){z&&Wa(),u&&Oa(),ta(),$a()},Wa=function(a){E&&(E.setActive(!1),F.setActive(!1),G.setActive(!1)),B&&B.removeClass("active"),a&&(C&&C.removeClass("active"),Qa("nooptions")),db("notacontrol"),Xa()},Xa=function(){x&&(x.deactivate(),x.activate())},Ya=function(){z&&z.deactivate(),E&&E.setActive(!1),F&&F.setActive(!1),G&&G.setActive(!1),x&&x.deactivate(),bb(),da(!0)},Za=function(){bb(),E&&E.getFeatures().clear(),u&&Oa(),ta(),t.getSource().clear(),e.hideDimension(),a("input#taskManagementTaskSubject").val(""),a("input#taskManagementTaskId").val(""),a("textarea#taskManagementTaskNotes").val(""),r.createTaskTypes(),r.createRecipients(),o.removePopup(),da(!0)},$a=function(){var b,c,e,f=t.getSource().getFeatures(),g=l.getMapProjection().name,h=new d.format.GeoJSON({});r.validateTaskFields()&&(ab(f),b=h.writeFeatures(f),c=JSON.parse(b),c.crs={type:"name",properties:{name:g}},b=JSON.stringify(c),b=b.replace(/null/g,"{}"),e={service:"ejb/TasksLocal",method:"submitGeojsonSketchTask",json:"true",type:a("select#taskManagementTaskType").val()||j.sketching.defaultTask,subject:a("input#taskManagementTaskSubject").val()||j.sketching.defaultSubject,description:a("textarea#taskManagementTaskNotes").val()||"",recipients:a("select#taskManagementTaskRecipient").val()||void 0,sketch:b,id:a("input#taskManagementTaskId").val()||""},p.postGSSRequest(e,"?service=ejb%2FTasksLocal&method=submitGeojsonSketchTask",function(b){b.response?a.publish("raiseStickyMessage",[j.sketching.submitFailure,{messageType:"warning",errorMessage:b.response}]):(a.publish("raiseTempMessage",[j.sketching.submitSuccess,{messageType:"success"}]),Za())},function(){a.publish("raiseStickyMessage",[j.sketching.submitFailure,{messageType:"warning"}])}))},_a=function(a){var b,c=d.color.asArray(a.getColor()),e=c.slice(0,3);return b=e.map(function(a){var b=a.toString(16);return b.length<2?"0"+b:b})},ab=function(a){b.each(a,function(a){var b,c,d=a.getGeometry().getType(),e={},f="",g="";a.getProperties().parserStyle?(b=a.getProperties().parserStyle.getStroke(),c=_a(b),a.unset("parserStyle"),d="arrow"):"Point"===d?a.getStyle()[1]&&a.getStyle()[1].getText()?(d="text",e.isTextLabel="true",b=a.getStyle()[1].getText().getStroke(),c=_a(b),e.colourRgb="#"+c[0]+c[1]+c[2]):(d="symbol",e.type=d,e.symbolName=a.getProperties().symbolName):"Polygon"===d?(b=a.getStyle().getStroke(),c=_a(b),0===a.getStyle().getFill().getColor()[3]?e.stroke="empty":e.stroke="solid",d="area"):(b=a.getStyle().getStroke(),c=_a(b),g=b.getLineDash(),f=g?"dash":"",g&&(g=g.toString()),e.stroke=f,e.dashPattern=g),c&&(e.type=d,e.colour="",e.colourRgb="#"+c[0]+c[1]+c[2]),a.setProperties(e)})},bb=function(){E&&(E.setActive(!1),F.setActive(!1),G.setActive(!1)),o.removePopup(),da(!0)},cb=function(a){var b=a.split("_");switch(b[0]){case"point":case"line":case"area":case"arrow":case"undo":case"redo":case"cancel":case"submit":o.removePopup();break;case"text":break;default:return null}},db=function(b){var c=a(".controlDescriptions .sketchControlDescription ",v),d=a(".controlDescriptions .hr-tip",v);c.hide(),d.hide(),b&&(a("#"+b).show(),"notacontrol"!==b&&d.show())},eb=function(a){a&&x&&(x.deactivate(),x.activate())};_();var fb={initialise:oa,toggleControl:cb,deactivateControl:Wa,enableTextControl:eb,hideDeleteFeature:Oa,showDeleteFeature:Na};return fb.__TEST_ONLY__={initialise:oa,clearSketch:Za,submitSketch:$a,clickListeners:Ra,addSymbolControls:na,addButtonToContext:Ma,showDeleteFeature:Na,deleteFeature:Pa,handleClicks:Ta,toggleControl:cb,cancelClick:Ua,finaliseClick:Va,getControls:function(){return V},setControls:function(a){V=a},setModifyTextControl:function(a){x=a},setButtonContainer:function(a){Q=a},getButtonContainer:function(){return Q},setButtonTemplate:function(a){P=a},setActiveButton:function(a){B=a},getActiveButton:function(){return B},setActiveOptionButton:function(a){C=a},getActiveOptionButton:function(){return C},setCardSelector:function(a){v=a},getCardSelector:function(){return v},setSketchLayer:function(a){t=a},setActiveControlName:function(a){A=a},setOlMap:function(a){w=a},getOlMap:function(){return w},setSelectControl:function(a){E=a},setTranslateControl:function(a){F=a},setModifyControl:function(a){G=a},setRotateControl:function(a){H=a}},fb});