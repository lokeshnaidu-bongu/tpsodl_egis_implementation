/*! ElectricOfficeWeb 5.0.1 2021-06-16 */
define(["jquery","underscore","OpenLayers3","hogan","text!sketching-partials/icon-button.html","text!sketching-icons/icon-textarea.svg","i18n!viewer/nls/messages","popovers","text!viewer-partials/popover-textarea.html","map-core-component/pubsub"],function(a,b,c,d,e,f,g,h,i){"use strict";var j,k,l,m,n,o,p,q,r=d.compile(f),s=d.compile(e),t=d.compile(i).render({messages:g}),u={width:16,height:16,color:"#000000",strokeWidth:1},v={descriptionTarget:"textDescription",optionsGroup:"textButtons",id:"text_red",svgBase64:""},w=a("textarea#popupInnerTextArea"),x=function(a,b){var c,d=a.getSource().getClosestFeatureToCoordinate(b);if(d&&d.get("isTextLabel")){var e=o.getPixelFromCoordinate(b),f=o.getPixelFromCoordinate(d.getGeometry().getFirstCoordinate()),g=Math.abs(f[0]-e[0]),h=Math.abs(f[1]-e[1]);g<5&&h<5&&(c=d)}return c},y=function(b,c){n=c,o=n.map;var d=g.sketching.textAreaPlaceHolder;o.getOverlayById("smallworld");k=x(n.sketchLayer,b.coordinate),k?a.publish("editingTextFeature",k):j=b.coordinate,a.publish("allowKeyPresses",[!1]),h.displayPopup(j,o,t),w=a("textarea#popupInnerTextArea"),k&&(d=k.get("name")),w.val(d),w.focus(),w.select(),p=a.subscribe("popoverCleared",A.bind(this,null))},z=function(b,c){k=b,o=c,j=k.getGeometry().getFirstCoordinate(),a.publish("allowKeyPresses",[!1]),h.displayPopup(j,o,t),w=a("textarea#popupInnerTextArea"),w.val(k.get("name")),w.focus(),w.select(),p=a.subscribe("popoverCleared",A.bind(this,k))},A=function(b){a.unsubscribe(p);var d=w.val();a.publish("allowKeyPresses",[!0]),d&&(b?(b.get("SYS!DELETED")||(b.set("name",d),b.setStyle(C(d))),a.publish("finishedEditingTextFeature",b)):(k=new c.Feature({geometry:new c.geom.Point(j),name:d,isTextLabel:!0}),k.setStyle(C(d)),n.sketchLayer.getSource().addFeature(k),a.publish("finishedCreatingTextFeature",k)))},B=function(a,b){var d=new c.style.Style({text:new c.style.Text({text:a,textAlign:"Left",fill:new c.style.Fill({color:"#FFFFFF"}),stroke:new c.style.Stroke({color:"#FFFFFF",width:3}),font:"13px Verdana,Arial,sans-serif",offsetY:b})}),e=new c.style.Style({text:new c.style.Text({text:a,textAlign:"Left",fill:new c.style.Fill({color:n.color}),stroke:new c.style.Stroke({color:n.color,width:1}),font:"13px Verdana,Arial,sans-serif",offsetY:b})});return[d,e]},C=function(b){var c,d=b.split("\n"),e=[],f=0;return a.each(d,function(a,b){c=B(b,f),e.push(c[0],c[1]),f+=16}),e},D=function(c,d){var e,f,g,i=a("#sketchControl #textButtons",d),j={};return c=c||(c={black:"#000000"}),b.each(c,function(b,c){e="text_"+c,j[e]={id:e,color:b,colorName:c},f=E({color:b}),g=F(f,{id:e}),i.append(a(g))}),q||(q=a.subscribe("terminateDrawingOperation",function(){p&&(a.unsubscribe(p),h.removePopup())}),a.subscribe("willDeleteFeature",function(a){k&&k.set("SYS!DELETED",!0)})),j},E=function(b){var c=a.extend({},u,b);return r.render(c)},F=function(b,c){var d=a.extend({},v,c);return d.svgBase64=btoa(b),s.render(d)},G=function(b){k=null,h.removePopup(),a.publish("allowKeyPresses",[!0])},H=function(a){l=a},I=function(a){m=a},J={setSketchLayer:H,setSketchApi:I,getSvgForControl:E,getButtonForSvg:F,addControls:D,closePopover:G,startTextCapture:y,startTextEdit:z,onPopupRemoval:A};return J.__TEST_ONLY__={setTextFeature:function(a){k=a},setTextAreaSelector:function(a){w=a},getExistingFeatureAtCoordinate:x,startTextCapture:y,getSubToken:function(){return p},getTextFeature:function(){return k},getTextCoord:function(){return j},setOlMap:function(a){o=a},makeTextStyles:B,gatherStyleInfo:C},J});