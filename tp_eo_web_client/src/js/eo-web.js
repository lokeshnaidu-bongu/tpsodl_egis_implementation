/*! ElectricOfficeWeb 5.0.1 2021-06-16 */
define(["date-helper","jquery","underscore","window-manager","i18n!nls/messages","hogan","OpenLayers3","popovers","map-helper","search-setup","asset-search","map-loader","text!src/partials/popover-controls.html","proj4","comms","find","sketching","plotting","internals","overlay","trace","object-details","object-info","map-core","map-street-view","map-layer-list","map-zoom","map","map-current-location","history","error-handler","highlighter","logout","export"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){"use strict";var q,r,s="main_map",t=f.compile(m).render({messages:e}),u=i.getMapProjection(),v=!0,w=function(){b.publish("resizeWindow")},x=function(){b.subscribe("mapInitialised",function(a,b){q=b,s=a,w(),y(),D()}),b.subscribe("gotoServerAsset",function(a,b){s===b&&h.createSearchResultPopover(a,q,s)}),b.subscribe("popoverButtonVisibilityControl",function(a,b,c){C(a,b)}),b.subscribe("requestPopoverControls",function(a){a(t)}),b.subscribe("wmtsClickActivate",function(){v=!0}),b.subscribe("wmtsClickDeactivate",function(){v=!1})},y=function(){var a=[];a.push(i.getMapLayers()),q.on("click",function(a){v&&(b.publish("clearHighlight",["main_map"]),b.publish("clearPopovers"),z(a))})},z=function(a){var b,c,d=a.frameState,e=d.viewState,f=e.resolution,g=d.layerStatesArray,h=g.length-1;for(i.setContinueSelecting(!0);h>=0;--h)if(b=g[h],c=b.layer,b.visible&&!i.isBaseLayer(c)&&f>=b.minResolution&&f<b.maxResolution){if(i.handleSpecialSelection(q,a,c),!i.getContinueSelecting())break;if(!c.getSource())continue;c.getSource().tileGrid&&A(c,a)}},A=function(a,b){var c,e,f,h,j,k,m,n,p,r,s=b.coordinate,t=a.getSource(),v=t.getTileGrid();i.setBusyCursor(),c=v.getTileCoordForCoordAndResolution(s,q.getView().getResolution()),f=t.getTileUrlFunction(),h=f(c,g.has.DEVICE_PIXEL_RATIO,g.proj.get(u.name)),j=h.split("TileCol=")[1].split("&")[0],k=h.split("TileRow=")[1],e=v.getTileCoordExtent(c),m=q.getPixelFromCoordinate([e[0],e[3]]),n=[Math.round(Math.abs(m[0]-b.pixel[0])),Math.round(Math.abs(m[1]-b.pixel[1]))],r=d.isTouchDevice()?l.touchPixelHitRadius||8:l.pixelHitRadius||5,p={url:t.getUrls()[0],service:"WMTS",layer:t.getLayer(),tilematrixset:t.getMatrixSet(),tilematrix:Math.round(q.getView().getZoom())-1,tilerow:k,tilecol:j,infoformat:"application/json",i:n[0],j:n[1],crs:u.name,request:"GetFeatureInfo",version:"1.0.0",pixel_hit_radius:r},o.getNodeRequest(p,function(a){B(b,a)},function(a,b,c){console.log(a,b,c),i.clearBusyCursor()})},B=function(c,d){var e,f;d.features.length>0&&(d.text=JSON.stringify(d,a.formatISODateString),d.coordinate=c.coordinate,f=b.parseJSON(d.text),h.updatePopupAtPosition(d.coordinate,f,q,s),e=[{lonlat:d.coordinate,features:f,map:q,mapName:s}],b.publish("featureSelected",e)),i.clearBusyCursor()},C=function(a,c){var d=i.getCollectionName(c),e=l.ShowConnectivityAvailableForCollections,f=b(a);"popoverConnectivity"===f.attr("id")&&(e?d?b.inArray(d,e)<0?f.css("display","none"):f.css("display","inline"):f.css("display","none"):f.css("display","inline")),c.indexOf("schematic_")!==-1&&"popoverButtonSendToTrace"===f[0].id&&f.css("display","none")},D=function(){j.setOlMap(q),j.setupAssetSearchContext({mapName:s,olMap:q}),r=j.getContexts(s);var a=b(".map #mapSearch");b(".form-search .input-group-btn .dropdown-menu li.search-item").click(function(c){b("#query").typeahead("destroy");var d=b(this),e=d.data("search-type"),f=r[e],g=b("#searchTypeIndicator",a);g.removeClass(),g.addClass(f.icon),b("#query").assetOrAddressSearch(f.searchOptions),b("#query").attr("placeholder",f.placeholderText)}),b("#query").assetOrAddressSearch(r.asset.searchOptions)},E=function(){d.init({mapFrameOptions:{mapName:s},eventSubscribe:x})},F={init:E},G=function(a){q=a};return F.__TEST_ONLY__={eventSubscribe:x,getFeatureInfo:A,setOlMap:G},F});